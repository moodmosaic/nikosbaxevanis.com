<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>SingleInstance(Of T) Class for Windows Phone 7</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1392664185" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1392664185" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1392664185" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>SingleInstance(Of T) Class for Windows Phone 7</h1><div class="post"><p>When building applications for&nbsp;a mobile operating system such as Windows Phone 7 (WP7) you might want (at times) to defer the creation of large objects, &nbsp;specifically when this creation is going to increase memory consumption.</p>

<p>While in the desktop CLR there is the <a title="Provides support for lazy initialization." href="http://msdn.microsoft.com/en-us/library/dd642331.aspx" target="_blank">Lazy(Of T) Class</a>, when working on WP7 this class does not exist (at least not at the time of this writing).</p>

<p>I find it a very&nbsp;repetitive task to manually produce a single instance object:</p>

<ol>
<li>Make it&rsquo;s constructor private.</li>
<li>Write the code for initialization.</li>
<li>Provide a getter method that returns the one and only instance.</li>
</ol>

<p>While you can not avoid step 2, it is possible to create a generic class that produces step 1 and step 3. Then, from the class constructor, you can pass the code that creates the object using a <a title="Encapsulates a method that has no parameters and returns a value of the type specified by the TResult parameter." href="http://msdn.microsoft.com/en-us/library/bb534960.aspx" target="_blank">Func(TResult) Delegate</a>.&nbsp;</p>

<p><strong>SingleInstance(Of T) Class</strong></p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">SingleInstance</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
<span class="err">{</span>
    <span class="nc">private</span> <span class="k">readonly</span> <span class="kt">object</span>  <span class="n">lockObj</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">@delegate</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">bool</span> <span class="n">isDelegateInvoked</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">T</span> <span class="n">@value</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">SingleInstance</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">this</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">SingleInstance</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">@delegate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">@delegate</span> <span class="p">=</span> <span class="n">@delegate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">T</span> <span class="n">Instance</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">isDelegateInvoked</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">T</span> <span class="n">temp</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">@delegate</span><span class="p">();</span>
                <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">ref</span> <span class="k">this</span><span class="p">.</span><span class="n">@value</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>

                <span class="kt">bool</span> <span class="n">lockTaken</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="c1">// WP7 does not support the overload with the
</span>                    <span class="c1">// Boolean indicating if the lock was taken.
</span>                    <span class="n">Monitor</span><span class="p">.</span><span class="nf">Enter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">lockObj</span><span class="p">);</span> <span class="n">lockTaken</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

                    <span class="k">this</span><span class="p">.</span><span class="n">isDelegateInvoked</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">finally</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">lockTaken</span><span class="p">)</span> <span class="p">{</span> <span class="n">Monitor</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">lockObj</span><span class="p">);</span> <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">@value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<blockquote>
<p>The code inside the &ldquo;T Instance&rdquo; public property&nbsp;uses interlocked constructs to&nbsp;produce a single T object. It has been discussed in the book CLR via C#, 3rd Edition, Microsoft Press, page&nbsp;846.</p>
</blockquote>

<p>The SingleInstance(Of T) class has many differences from the &nbsp;System.Lazy(Of T)&nbsp;class in the desktop CLR.</p>

<ul>
<li>The System.Lazy(Of T) class takes a&nbsp;<a title="Specifies how a System.Lazy(Of T) instance synchronizes access among multiple threads." href="http://msdn.microsoft.com/en-us/library/system.threading.lazythreadsafetymode.aspx" target="_self">LazyThreadSafetyMode</a>&nbsp;enumeration. This enumeration contains 3 members (None, PublicationOnly, ExecutionAndPublication). The SingleInstance(Of T) class uses the interlocked constructs to produce a single instance. This is similar with passing LazyThreadSafetyMode.ExecutionAndPublication in the System.Lazy(Of T) class.</li>
<li>The System.Lazy(Of T) class works with classes (reference types) and structs (value types). The value types are boxed internally. The SingleInstance(Of T) class works only with reference types.</li>
<li>Finally, the System.Lazy(Of T) class is written, tested and supported by Microsoft, while the SingleInstance(Of T) is not.</li>
</ul>

<p>Keep in mind that the SingleInstance(Of T)&nbsp;class uses a&nbsp;Func(TResult) Delegate.&nbsp;There is a known performance hit when calling delegates compared to direct method calls. (See the Delegates section <a title="Writing Faster Managed Code: Know What Things Cost by Jan Gray." href="http://msdn.microsoft.com/en-us/library/ms973852.aspx" target="_blank">here</a>).</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2010%2F11%2F20%2Fsingleinstance-of-t-class-for-windows-phone-7%2F&text=SingleInstance%28Of+T%29+Class+for+Windows+Phone+7&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">November 20, 2010</div><div class="categories">Published in<a class="category" href="/category/async/">Async&nbsp;</a> on November 20, 2010</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>