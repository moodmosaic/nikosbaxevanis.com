<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Using Reflection to Dynamically Invoke the NHibernate Profiler</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1392019782" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1392019782" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1392019782" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Using Reflection to Dynamically Invoke the NHibernate Profiler</h1><div class="post"><p>If you are using NHibernate&#0160;as your Object-relational mapping (ORM) solution, then chances are you are also using the <a href="http://nhprof.com" target="_blank" title="NHibernate Profiler is a real-time visual debugger allowing a development team to gain valuable insight and perspective into their usage of NHibernate. The product is architected with input coming from many top industry leaders within the NHibernate community.">NHibernate Profiler</a>. You can see the exact SQL queries sent to the database and also detect&#0160;<a href="http://nhprof.com/Learn/Alerts" target="_blank" title="Alerts are presented in a concise code-review manner indicating patterns of misuse by your application.">common pitfalls</a>, among others.</p>

<p>NHibernate Profiler&#0160;is developed by Hibernating Rhinos and&#0160;Blue Spire Consulting, Inc. The <a href="http://nhprof.com/About" target="_blank" title="The NHibernate Profiler was developed by Hibernating Rhinos. The user interface was built by Blue Spire Consulting, Inc.">main contributers</a> behind this tool are Oren Eini (NHibernate, Castle Project, RavenDB), Christopher Bennage (Sams Teach Yourself WPF in 24 Hours) and Rob Eisenberg (Sams Teach Yourself WPF in 24 Hours, Caliburn, Caliburn Micro). As you can see, this tool is not only interesting for what it does, but it has also interesting people behind it.</p>

<p>Using the NHibernate Profiler in your application is very easy:</p>

<ol>
<li><strong>Add a reference</strong> to HibernatingRhinos.Profiler.Appender.dll assembly.</li>
<li>Invoke the NHibernateProfiler.Initialize method from your code.</li>
</ol>

<p>The problem is, you (might) need to remove the referenced assembly&#0160;every time you ship. Even if you decide to keep it, you need to invoke the Initialize method from your code inside a method marked with the&#0160;<a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.conditionalattribute.aspx" target="_blank" title="Indicates to compilers that a method call or attribute should be ignored unless a specified conditional compilation symbol is defined.">ConditionalAttribute</a>&#0160;class so the compiler ignores it unless you are running in debug mode.</p>

<p>You can avoid adding a reference (step 1), and invoke the Initialize method dynamically&#0160;using reflection:</p>

<p>1. In the&#0160;<a href="http://msdn.microsoft.com/en-us/library/aa903313(VS.71).aspx" target="_blank" title="Contains custom application settings. This is a predefined configuration section provided by the .NET Framework.">&lt;appSettings&gt;</a> element include the following keys:</p>
<pre class="highlight python"><span class="o">&lt;</span><span class="n">appSettings</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">add</span> <span class="n">key</span><span class="o">=</span><span class="s">&quot;NHibernate_ProfilerAssembly&quot;</span>
         <span class="n">value</span><span class="o">=</span><span class="s">&quot;HibernatingRhinos.Profiler.Appender.dll&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">add</span> <span class="n">key</span><span class="o">=</span><span class="s">&quot;NHibernate_ProfilerDirectory&quot;</span>
         <span class="n">value</span><span class="o">=</span><span class="s">&quot;&lt;your_path&gt;&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">add</span> <span class="n">key</span><span class="o">=</span><span class="s">&quot;NHibernate_ProfilerMethod&quot;</span>
         <span class="n">value</span><span class="o">=</span><span class="s">&quot;Initialize&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">add</span> <span class="n">key</span><span class="o">=</span><span class="s">&quot;NHibernate_ProfilerType&quot;</span>
         <span class="n">value</span><span class="o">=</span><span class="s">&quot;NHibernateProfiler&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">appSettings</span><span class="o">&gt;</span>
</pre>
<p>2. For housekeeping you can define an interface.</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IIntegrateProfiler</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">SetNHibernateProfiler</span><span class="p">(</span><span class="kt">string</span> <span class="n">directory</span><span class="p">,</span> <span class="kt">string</span> <span class="n">assembly</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">CanUseProfiler</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">string</span> <span class="n">ProfilerPath</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>3. Inside the&#0160;your bootstrapper class, or the class where the&#0160;<a href="http://nhibernate.svn.sourceforge.net/viewvc/nhibernate/trunk/nhibernate/src/NHibernate/ISessionFactory.cs?revision=5259&amp;view=markup" target="_blank" title="Usually an application has a single SessionFactory. Threads servicing client requests obtain ISession&#39;s from the factory.">ISessionFactory</a>&#0160;is built, implement the above interface.</p>

<blockquote>
<p style="text-align: justify;">In the example below the ValidateDirectory and ValidateFileName methods are not included as well as the&#0160;this.profilerPath &#0160;private instance field.</p>
</blockquote>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">void</span> <span class="nf">SetNHibernateProfiler</span><span class="p">(</span><span class="kt">string</span> <span class="n">directory</span><span class="p">,</span> <span class="kt">string</span> <span class="n">assembly</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">ValidateDirectory</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">profilerPath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">assembly</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nf">ValidateFileName</span><span class="p">(</span><span class="n">profilerPath</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">profilerPath</span> <span class="p">=</span> <span class="n">profilerPath</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">profilerPath</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="kt">bool</span> <span class="n">CanUseProfiler</span>
<span class="p">{</span>
    <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">profilerPath</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="kt">string</span> <span class="n">ProfilerPath</span>
<span class="p">{</span>
    <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">profilerPath</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>4. Finally, from your code you can check whether the&#0160;<span style="font-family: Consolas; font-size: 13px;">CanUseProfiler&#0160;</span>property returns true and call the&#0160;<span style="font-family: Consolas; font-size: 13px;">InitializeProfiler&#0160;</span>method below:</p>
<pre class="highlight csharp"><span class="k">private</span> <span class="k">void</span> <span class="nf">InitializeProfiler</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Assembly</span> <span class="n">asm</span>  <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">LoadFileLoadFrom</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">ProfilerPath</span><span class="p">);</span>
    <span class="n">Type</span> <span class="n">profiler</span> <span class="p">=</span> <span class="n">asm</span><span class="p">.</span><span class="nf">GetExportedTypes</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> 
        <span class="n">x</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">&quot;NHibernate_ProfilerType&quot;</span><span class="p">])</span>
            <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">();</span>

     <span class="k">if</span> <span class="p">(</span><span class="n">profiler</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">MethodInfo</span> <span class="n">initialize</span> <span class="p">=</span> <span class="n">profiler</span><span class="p">.</span><span class="nf">GetMethods</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> 
           <span class="n">x</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">ConfigurationManager</span>
             <span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">&quot;NHibernate_ProfilerMethod&quot;</span><span class="p">]).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">initialize</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="n">initialize</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
         <span class="p">}</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre>
<blockquote>
<p style="text-align: justify;">Actually, the same technique can be used for the other profilers too (<a href="http://efprof.com/" target="_blank" title="Entity Framework Profiler is a real-time visual debugger allowing a development team to gain valuable insight and perspective into their usage of Entity Framework. The product is architected with input coming from many top industry leaders within the OR/M community.">EFProf</a>,&#0160;<a href="http://l2sprof.com/" target="_blank" title="Linq to Sql Profiler is a real-time visual debugger allowing a development team to gain valuable insight and perspective into their usage of Linq to Sql. The product is architected with input coming from many top industry leaders within the OR/M community.">L2SProf</a>, etc).</p>
</blockquote>

<p>Don&#39;t forget to remove the&#0160;referenced assembly from your project.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2010%2F11%2F03%2Fusing-reflection-to-dynamically-invoke-the-nhibernate-profiler%2F&text=Using+Reflection+to+Dynamically+Invoke+the+NHibernate+Profiler&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">November 03, 2010</div><div class="categories">Published in<a class="category" href="/category/nhibernate/">NHibernate&nbsp;</a> on November 03, 2010</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>