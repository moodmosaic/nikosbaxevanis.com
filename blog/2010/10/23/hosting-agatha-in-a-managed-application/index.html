<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Hosting Agatha in a Managed Application</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1394818175" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1394818175" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1394818175" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Hosting Agatha in a Managed Application</h1><div class="post"><p>When designing your <a href="http://en.wikipedia.org/wiki/Enterprise_Service_Layer" target="_blank" title="The Enterprise Service Layer (ESL) is the highest level of abstraction in a SOA architecture.">Service Layer</a> you need to choose a communication mechanism according to your needs. Duplex, Fire and Forget, Reliable Sessions and <a href="http://en.wikipedia.org/wiki/Request-response" target="_blank" title="Request-response, also known as request-reply, is a message exchange pattern in which a requestor sends a request message to a replier system which receives and processes the request, ultimately returning a message in response.">Request Response</a> are the most common messaging patterns.</p>

<p>With Request-response, the client expects to receive a response for every message that&#39;s been sent. You can design such a Service Layer using an <a href="http://en.wikipedia.org/wiki/Enterprise_service_bus#ESB_architecture" target="_blank" title="In an enterprise architecture making use of an ESB, an application will communicate via the bus, which acts as a message broker between applications.">ESB architecture</a> if you need to connect different applications (even from different platforms). Though, if you need to write a typical client - back-end - database application you can choose not to go with an ESB (Rhino ServiceBus, NServiceBus) and use WCF.</p>

<blockquote>
<p>When using NHibernate in an enterprise application the most common issue is how to automatically open and close a Session (per Request). With WCF you need to follow the steps described <a href="http://igloocoder.com/archive/2008/07/21/nhibernate-on-wcf.aspx" target="_blank" title="NHibernate on WCF">here</a>. Also&#0160;for each of your services you need to expose an&#0160;<a href="http://msdn.microsoft.com/en-us/library/aa480190.aspx#introt_topic2" target="_blank" title="The mnemonic &quot;ABC&quot; can be used to remember Address / Binding / Contract.">ABC</a>&#0160;via app.config.&#0160;On the other hand using Rhino ServiceBus and NServiceBus makes your life a lot easier.</p>
</blockquote>

<p>Davy Brion mentions <a href="http://davybrion.com/blog/2009/07/why-i-dislike-classic-or-typical-wcf-usage/" target="_blank" title="Why I Dislike Classic Or Typical WCF Usage.">here</a>&#0160;with more detail what I&#39;ve discussed above and he provides the <a href="http://code.google.com/p/agatha-rrsl/" target="_blank" title="agatha-rrsl - Implementation of the Request/Response Service Layer for .NET.">Agatha</a> project. With it, you define <a href="http://code.google.com/p/agatha-rrsl/source/browse/trunk/Agatha.ServiceLayer/RequestHandler.cs" target="_blank" title="Agatha.ServiceLayer.RequestHandler">RequestHandlers</a> (like <a href="http://github.com/hibernating-rhinos/rhino-esb/blob/master/Rhino.ServiceBus/ConsumerOf.cs" target="_blank" title="Rhino.ServiceBus.ConsumerOf&lt;T&gt;">Consumers</a> in the ESB world) and Agatha infrastructure will handle the rest. Everything is done with a single endpoint which makes you forget about app.config and ABCs.</p>

<blockquote>
<p>With Agatha NHibernate Session-per-Request is easy. You can use your favorite DI container and have a session provided through your handler&#39;s constructor. You can even abstract the session by following the steps described <a href="http://davybrion.com/blog/2009/12/using-nhibernate-in-your-service-layer/" target="_blank" title="Using NHibernate In Your Service Layer">here</a>.</p>
</blockquote>

<p>With Agatha, you can host your services easily on IIS or in a Console Application using <a href="http://www.coretechnologies.com/products/AlwaysUp/" target="_blank" title="AlwaysUp runs your application (32/64-bit executable, batch file, shortcut, java, perl, etc.) as a Windows Service, managing and monitoring it constantly to ensure 100% uptime.">AlwaysUp</a>. If you choose the latter there are a few things to do inside your Main() method.</p>
<pre class="highlight text">Uri  baseAddress = new Uri(&quot;&lt;uriString goes here&gt;&quot;);
ServiceHost host = new ServiceHost(typeof(WcfRequestProcessor), baseAddress);
host.Open();

// Agatha's WcfRequestProcessor handles the requests.
// Your service is up. There is really nothing else to do here.

System.Console.ReadKey(false);
host.Close();
</pre>
<p>Here I create an instance of the <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.servicehost.aspx" target="_blank" title="Provides a host for services.">ServiceHost</a> class, passing a <a href="http://code.google.com/p/agatha-rrsl/source/browse/trunk/Agatha.ServiceLayer/WCF/WcfRequestProcessor.cs" target="_blank" title="Agatha.ServiceLayer.WCF.WcfRequestProcessor">WcfRequestProcessor</a>&#0160;type that represents the service type and the base address Uniform Resource Identifier (URI) to the ServiceHost.</p>

<p>Here is the generic app.config that Agatha needs:</p>
<pre class="highlight python"><span class="o">&lt;</span><span class="err">?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span><span class="err">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">configuration</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">system</span><span class="o">.</span><span class="n">serviceModel</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">services</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">service</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Agatha.ServiceLayer.WCF.WcfRequestProcessor&quot;</span>
               <span class="n">behaviorConfiguration</span><span class="o">=</span><span class="s">&quot;RequestProcessorBehavior&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">endpoint</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                  <span class="n">contract</span><span class="o">=</span><span class="s">&quot;Agatha.Common.WCF.IWcfRequestProcessor&quot;</span>
                  <span class="nb">bin</span><span class="n">ding</span><span class="o">=</span><span class="s">&quot;basicHttpBinding&quot;</span>
                  <span class="nb">bin</span><span class="n">dingConfiguration</span><span class="o">=</span><span class="s">&quot;RequestProcessorBinding&quot;</span><span class="o">/&gt;</span>
      <span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">services</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">bin</span><span class="n">dings</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">basicHttpBinding</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nb">bin</span><span class="n">ding</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;RequestProcessorBinding&quot;</span>
                 <span class="nb">max</span><span class="n">ReceivedMessageSize</span><span class="o">=</span><span class="s">&quot;2147483647&quot;</span>
                 <span class="n">receiveTimeout</span><span class="o">=</span><span class="s">&quot;00:30:00&quot;</span>
                 <span class="n">sendTimeout</span><span class="o">=</span><span class="s">&quot;00:30:00&quot;</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">readerQuotas</span> <span class="nb">max</span><span class="n">StringContentLength</span><span class="o">=</span><span class="s">&quot;2147483647&quot;</span>
                        <span class="nb">max</span><span class="n">ArrayLength</span><span class="o">=</span><span class="s">&quot;2147483647&quot;</span><span class="o">/&gt;</span>
          <span class="o">&lt;</span><span class="n">security</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;None&quot;</span> <span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nb">bin</span><span class="n">ding</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">basicHttpBinding</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nb">bin</span><span class="n">dings</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">behaviors</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">serviceBehaviors</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">behavior</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;RequestProcessorBehavior&quot;</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">serviceMetadata</span> <span class="n">httpGetEnabled</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="o">/&gt;</span>
          <span class="o">&lt;</span><span class="n">serviceDebug</span> <span class="n">includeExceptionDetailInFaults</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="o">/&gt;</span>
          <span class="o">&lt;</span><span class="n">dataContractSerializer</span> <span class="nb">max</span><span class="n">ItemsInObjectGraph</span><span class="o">=</span><span class="s">&quot;2147483647&quot;</span><span class="o">/&gt;</span>
          <span class="o">&lt;</span><span class="n">serviceThrottling</span> <span class="nb">max</span><span class="n">ConcurrentCalls</span><span class="o">=</span><span class="s">&quot;500&quot;</span>
                             <span class="nb">max</span><span class="n">ConcurrentInstances</span><span class="o">=</span><span class="s">&quot;500&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="n">behavior</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">serviceBehaviors</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">behaviors</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">system</span><span class="o">.</span><span class="n">serviceModel</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">startup</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">supportedRuntime</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;v4.0&quot;</span>
                      <span class="n">sku</span><span class="o">=</span><span class="s">&quot;.NETFramework,Version=v4.0&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="n">startup</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">runtime</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">gcServer</span> <span class="n">enabled</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="n">runtime</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">configuration</span><span class="o">&gt;</span>
</pre>
<p>I included the&#0160;<a href="http://msdn.microsoft.com/en-us/library/ms229357.aspx" target="_blank" title="Specifies whether the common language runtime runs server garbage collection.">&lt;gcServer&gt;</a>&#0160;element to instruct CLR to use&#0160;server garbage collection. Inside your Main() method you can include the code below:</p>
<pre class="highlight text">Console.WriteLine(&quot;{0} is {1}running with server GC.&quot;,
    Assembly.GetEntryAssembly().GetName().Name,
    GCSettings.IsServerGC == true ? string.Empty : &quot;not &quot;);
</pre>
<p>I would really like to share how it looks in <a href="http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx" target="_blank" title="Process Explorer by Mark Russinovich">Process Explorer</a> when handling 6000 requests using Agatha.</p>

<p><img src="http://farm9.staticflickr.com/8194/8397465885_bb9b3f236e_o.png" alt="" /></p>

<p style="text-align: center;"><strong>&#0160;</strong><span style="font-size: small;"><em>Agatha 6000 request-response synchronous</em></span></p>

<p><img src="http://farm9.staticflickr.com/8366/8398554490_8d5c2ec5cd_o.png" alt="" /></p>

<p style="text-align: center;"><strong>&#0160;</strong><span style="font-size: small;"><em>Agatha 6000 request-response asynchronous</em></span></p>

<blockquote>
<p>Why in the&#0160;asynchronous case&#0160;the memory consumption is a little higher? Well, this is something expected. Every asynchronous call creates an <a href="http://msdn.microsoft.com/en-us/library/system.iasyncresult.aspx" target="_blank" title="Represents the status of an asynchronous operation.">IAsyncResult</a> object. So even that the calls are non-blocking we have an overhead of 6000 IAsyncResult objects on the heap (yes, on the heap since they are not value types). Though, as you can see from the screenshot, when the GC &#0160;kicks in the memory is reclaimed.</p>
</blockquote>

<p>Well that&#39;s it! Agatha works great, it&#39;s great, I really like it. Goodbye to the existing (and conservative, and painful) WCF usage.</p>

<p>The sample application can be found <a href="https://github.com/moodmosaic/BonusBits.CodeSamples" target="_blank" title="BonusBits Blog source-code.">here</a>.</p>

<p>Make sure you are running the application with elevated priviledges else a System.ServiceModel.AddressAccessDeniedException will be thrown indicating that your process does not have access rights to get registered at the base address were your service is hosted.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2010%2F10%2F23%2Fhosting-agatha-in-a-managed-application%2F&text=Hosting+Agatha+in+a+Managed+Application&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">October 23, 2010</div><div class="categories">Published in<a class="category" href="/category/wcf/">WCF&nbsp;</a> on October 23, 2010</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>