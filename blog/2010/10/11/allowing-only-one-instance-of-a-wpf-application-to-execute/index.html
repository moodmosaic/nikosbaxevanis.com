<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="width=device-width" name="viewport" /><title>Allowing only one instance of a WPF application to execute</title><link href="/images/favicon.ico" rel="icon" type="image/x-icon" /><link href="/feed" rel="alternate" type="application/rss+xml" /><link href="/stylesheets/blog.css?1389050896" media="screen" rel="stylesheet" type="text/css" /></head><body><body><div id="title"><div><h1><a href="/blog" style="color: #222">moodmosaic</a></h1><div><span>by </span><a href="/">Nikos Baxevanis </a><a href="http://creativecommons.org/licenses/by/3.0/" style="color: #877">(license)</a></div></div><div class="line"></div></div><div id="full"><h1><a>Allowing only one instance of a WPF application to execute</a></h1><div class="undertitle"><span class="date">Filed under </span><a class="tag" href="/blog#wpf">wpf</a></div><p>Sometimes, for any reason, you want to have only one instance per application.</p>

<p>Search on the internet and you will find&nbsp;<a href="http://www.google.gr/search?sourceid=chrome&amp;ie=UTF-8&amp;q=wpf+single+instance" target="_blank">many different ways</a> of doing this. However, inside Jeffrey Ricther&rsquo;s <a title="CLR via C#, Third Edition" href="http://www.microsoft.com/learning/en/us/book.aspx?ID=13874" target="_blank">excellent book</a>&nbsp;there is a way&nbsp;of allowing only one instance of an application (Console, WinForms, WPF) to execute at any given time using kernel-mode constructs.</p>

<p>Using what has been described in the book and searching at <a href="http://www.pinvoke.net/default.aspx/user32/ShowWindow.html" target="_blank">P/Invoke.net</a>, I wrote some code that works with WPF applications. The code also attempts to set focus on the window and if it&rsquo;s minimized it will attempt to restore it.&nbsp;</p>

<pre><code class="c#">using System;
using System.Diagnostics;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Threading;
using System.Windows;

internal partial class App : Application
{
    private static readonly Semaphore singleInstanceWatcher;
    private static readonly bool createdNew;

    static App()
    {
        // Ensure other instances of this application are not running.
        singleInstanceWatcher = new Semaphore(
            0, // Initial count.
            1, // Maximum count.
            Assembly.GetExecutingAssembly().GetName().Name,
            out createdNew);

        if (createdNew)
        {
            // This thread created the kernel object so no other instance
            // of this application must be running.
        }
        else
        {
            // This thread opened an existing kernel object with the same
            // string name; another instance of this app must be running now.

            // Gets a new System.Diagnostics.Process component and the
            // associates it with currently active process.
            Process current = Process.GetCurrentProcess();

            // Enumerate through all the process resources on the share
            // local computer that the specified process name.
            foreach (Process process in
                 Process.GetProcessesByName(current.ProcessName))
            {
                if (process.Id != current.Id)
                {
                    NativeMethods.SetForegroundWindow(
                        process.MainWindowHandle);
                    NativeMethods.ShowWindow(process.MainWindowHandle, 
                        WindowShowStyle.Restore);
                    break;
                }
            }

            // Terminate this process and gives the underlying operating 
            // system the specified exit code.
            Environment.Exit(-2);
        }
    }

    private static class NativeMethods
    {
        /// &lt;summary&gt;
        /// Brings the thread that created the specified window into the
        /// foreground and activates the window. Keyboard input is directed
        /// to the window, and various visual cues are changed for the user.
        /// The system assigns a slightly higher priority to the thread that
        /// created the foreground window than it does to other threads.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;hWnd&quot;&gt;A handle to the window that should be
        /// activated and brought to the foreground.
        /// &lt;/param&gt;
        /// &lt;returns&gt;If the window was brought to the foreground, the
        /// return value is nonzero. &lt;/returns&gt;
        [DllImport(&quot;user32.dll&quot;)]
        internal static extern bool SetForegroundWindow(IntPtr hWnd);

        /// &lt;summary&gt;Shows a Window&lt;/summary&gt;
        /// &lt;remarks&gt;
        /// &lt;para&gt;To perform certain special effects when showing or hiding a
        /// window, use AnimateWindow.&lt;/para&gt;
        /// &lt;para&gt;The first time an application calls ShowWindow, it should use
        /// the WinMain function&#39;s nCmdShow parameter as its nCmdShow ..
        /// Subsequent calls to ShowWindow must use one of the values in the
        /// given list, instead of the one specified by the WinMain function&#39;s
        /// nCmdShow parameter.&lt;/para&gt;
        /// &lt;para&gt;As noted in the discussion of the nCmdShow parameter, the
        /// nCmdShow value is ignored in the first call to ShowWindow if the
        /// program that launched the application specifies startup information
        /// in the structure. In this case, ShowWindow uses the information
        /// specified in the STARTUPINFO structure to show the window. On
        /// subsequent calls, the application must call ShowWindow with ..
        /// set to SW_SHOWDEFAULT to use the startup information provided by ..
        /// program that launched the application. This behavior is designed ..
        /// the following situations: &lt;/para&gt;
        /// &lt;list type=&quot;&quot;&gt;
        ///    &lt;item&gt;Applications create their main window by calling ..
        ///    with the WS_VISIBLE flag set. &lt;/item&gt;
        ///    &lt;item&gt;Applications create their main window by calling ..
        ///    with the WS_VISIBLE flag cleared, and later call ShowWindow ..
        ///    SW_SHOW flag set to make it visible.&lt;/item&gt;
        /// &lt;/list&gt;&lt;/remarks&gt;
        /// &lt;param name=&quot;hWnd&quot;&gt;Handle to the window.&lt;/param&gt;
        /// &lt;param name=&quot;nCmdShow&quot;&gt;Specifies how the window is to be shown.
        /// This parameter is ignored the first time an application calls
        /// ShowWindow, if the program that launched the application provides a
        /// STARTUPINFO structure. Otherwise, the first time ShowWindow .. ,
        /// the value should be the value obtained by the WinMain function ..
        /// nCmdShow parameter. In subsequent calls, this parameter ..
        /// the WindowShowStyle members.&lt;/param&gt;
        /// &lt;returns&gt;
        /// If the window was previously visible, the return value is nonzero.
        /// If the window was previously hidden, the return value is zero.
        /// &lt;/returns&gt;
        [DllImport(&quot;user32.dll&quot;)]
        internal static extern bool ShowWindow(IntPtr hWnd,
            WindowShowStyle nCmdShow);
    }

    /// &lt;summary&gt;
    /// Enumeration of the different ways of showing a window.&lt;/summary&gt;
    internal enum WindowShowStyle : uint
    {
        /// &lt;summary&gt;Hides the window and activates another window.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_HIDE&lt;/remarks&gt;
        Hide = 0,
        /// &lt;summary&gt;Activates and displays a window. If the window ..
        /// or maximized, the system restores it to its original size and
        /// position. An application should specify this flag when displaying
        /// the window for the first time.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOWNORMAL&lt;/remarks&gt;
        ShowNormal = 1,
        /// &lt;summary&gt;Activates the window and displays it ..&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOWMINIMIZED&lt;/remarks&gt;
        ShowMinimized = 2,
        /// &lt;summary&gt;Activates the window and displays it ..&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOWMAXIMIZED&lt;/remarks&gt;
        ShowMaximized = 3,
        /// &lt;summary&gt;Maximizes the specified window.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_MAXIMIZE&lt;/remarks&gt;
        Maximize = 3,
        /// &lt;summary&gt;Displays a window in its most recent size and position.
        /// This value is similar to &quot;ShowNormal&quot;, except the window is not
        /// actived.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOWNOACTIVATE&lt;/remarks&gt;
        ShowNormalNoActivate = 4,
        /// &lt;summary&gt;Activates the window and displays it in its current size
        /// and position.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOW&lt;/remarks&gt;
        Show = 5,
        /// &lt;summary&gt;Minimizes the specified window and activates the next
        /// top-level window in the Z order.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_MINIMIZE&lt;/remarks&gt;
        Minimize = 6,
        /// &lt;summary&gt;Displays the window as a minimized window. This value is
        /// similar to &quot;ShowMinimized&quot;, except the window ..&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOWMINNOACTIVE&lt;/remarks&gt;
        ShowMinNoActivate = 7,
        /// &lt;summary&gt;Displays the window in its current size and position. This
        /// value is similar to &quot;Show&quot;, except the window ..&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOWNA&lt;/remarks&gt;
        ShowNoActivate = 8,
        /// &lt;summary&gt;Activates and displays the window. If the window is
        /// minimized or maximized, the system restores it to its original size
        /// and position. An application should specify this flag ..
        /// a minimized window.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_RESTORE&lt;/remarks&gt;
        Restore = 9,
        /// &lt;summary&gt;Sets the show state based on the SW_ value specified ..
        /// STARTUPINFO structure passed to the CreateProcess function by the
        /// program that started the application.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_SHOWDEFAULT&lt;/remarks&gt;
        ShowDefault = 10,
        /// &lt;summary&gt;Windows 2000/XP: Minimizes a window, even if the thread
        /// that owns the window is hung. This flag should only be used when
        /// minimizing windows from a different thread.&lt;/summary&gt;
        /// &lt;remarks&gt;See SW_FORCEMINIMIZE&lt;/remarks&gt;
        ForceMinimized = 11
    }
}
</code></pre>

<p>One improvement would be to restore the window only if it&rsquo;s minimized by checking the return value of SetForegroundWindow method. I leave this to you, go on and adapt it to your own needs.</p>
</div><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'bonusbits';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script></body><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>