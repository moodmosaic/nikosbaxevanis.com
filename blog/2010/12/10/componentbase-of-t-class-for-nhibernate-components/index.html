<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>ComponentBase(Of T) Class for NHibernate Components</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1391190213" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1391190213" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1391190213" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>ComponentBase(Of T) Class for NHibernate Components</h1><div class="post"><blockquote>
<p>This post aims to provide a way to implement a base class for NHibernate components also known as Value Objects in Domain-driven design.</p>
</blockquote>

<p><img src="http://farm9.staticflickr.com/8494/8398555268_0491f387b3_o.png" alt="" /></p>

<p>In my <a href="http://www.nikosbaxevanis.com/bonus-bits/2010/12/component-collections-in-nhibernate.html" target="_blank" title="Component Collections in NHibernate.">previous post</a> I discussed about the case where you want to map a component with NHibernate and introduced the ComponentBase(Of T) class. However, to make it&#0160;straightforward&#0160;that you need to override Equals (you also need to override GetHashCode) in your derived classes, I modified the ComponentBase(Of T) class to implement the <a href="http://msdn.microsoft.com/en-us/library/ms131187.aspx" target="_blank" title="Defines a generalized method that a value type or class implements to create a type-specific method for determining equality of instances.">IEquatable(Of T)</a> interface.&#0160;Furthermore, since NHibernate works only with reference types (that is, a class) I also constrained it to accept only reference types.</p>

<p>Here is the Component(Of T) class:</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ComponentBase</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> 
    <span class="p">:</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> 
<span class="err">{</span>
    <span class="c1">/// &lt;summary&gt;
</span>    <span class="c1">/// Indicates whether the current object is equal to another
</span>    <span class="c1">/// object of the same type.
</span>    <span class="c1">/// &lt;/summary&gt;
</span>    <span class="c1">/// &lt;param name=&quot;other&quot;&gt;An object to compare with this object.
</span>    <span class="c1">/// &lt;/param&gt;
</span>    <span class="c1">/// &lt;returns&gt;true if the current object is equal to the other
</span>    <span class="c1">/// parameter; otherwise, false.&lt;/returns&gt;
</span>    <span class="nc">public</span> <span class="k">abstract</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">T</span> <span class="n">other</span><span class="p">);</span>

    <span class="c1">/// &lt;summary&gt;
</span>    <span class="c1">/// Serves as a hash function for a particular type,
</span>    <span class="c1">/// suitable for use in hashing
</span>    <span class="c1">/// algorithms and data structures such as a hash table.
</span>    <span class="c1">/// &lt;/summary&gt;
</span>    <span class="c1">/// &lt;returns&gt;
</span>    <span class="c1">/// A hash code for this instance of the type.
</span>    <span class="c1">/// &lt;/returns&gt;
</span>    <span class="k">public</span> <span class="k">abstract</span> <span class="kt">int</span> <span class="nf">GetHashCodeForType</span><span class="p">();</span>

    <span class="c1">/// &lt;summary&gt;
</span>    <span class="c1">/// Determines whether the specified &lt;see cref=&quot;System.Object&quot;/&gt;
</span>    <span class="c1">/// is equal to this instance.
</span>    <span class="c1">/// &lt;/summary&gt;
</span>    <span class="c1">/// &lt;param name=&quot;obj&quot;&gt;The &lt;see cref=&quot;System.Object&quot;/&gt; to
</span>    <span class="c1">/// compare with this instance.
</span>    <span class="c1">/// &lt;/param&gt;
</span>    <span class="c1">/// &lt;returns&gt;
</span>    <span class="c1">///     &lt;c&gt;true&lt;/c&gt; if the specified &lt;see cref=&quot;System.Object&quot;/&gt;
</span>    <span class="c1">///     is equal to this instance;
</span>    <span class="c1">///     otherwise, &lt;c&gt;false&lt;/c&gt;.
</span>    <span class="c1">/// &lt;/returns&gt;
</span>    <span class="k">public</span> <span class="k">sealed</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// The given object to compare to can't be null.
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// If objects are different types, they can't be equal.
</span>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">GetType</span><span class="p">()</span> <span class="p">!=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">GetType</span><span class="p">())</span> <span class="p">{</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">return</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">obj</span> <span class="k">as</span> <span class="n">T</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;
</span>    <span class="c1">/// Returns a hash code for this instance.
</span>    <span class="c1">/// &lt;/summary&gt;
</span>    <span class="c1">/// &lt;returns&gt;
</span>    <span class="c1">/// A hash code for this instance, suitable for
</span>    <span class="c1">/// use in hashing algorithms and data structures
</span>    <span class="c1">/// like a hash table.
</span>    <span class="c1">/// &lt;/returns&gt;
</span>    <span class="k">public</span> <span class="k">sealed</span> <span class="k">override</span> <span class="kt">int</span> <span class="nf">GetHashCode</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">GetHashCodeForType</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Below are some test cases:</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>

<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">ComponentBaseTest</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">MockType</span> 
         <span class="p">:</span> <span class="n">ComponentBase</span><span class="p">&lt;</span><span class="n">MockType</span><span class="p">&gt;</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">TheSameInstanceHasTheSameHashCode</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">MockType</span> <span class="n">mt1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
        <span class="n">MockType</span> <span class="n">mt2</span> <span class="p">=</span> <span class="n">mt1</span><span class="p">;</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">mt1</span><span class="p">.</span><span class="nf">GetHashCode</span><span class="p">(),</span> <span class="n">mt2</span><span class="p">.</span><span class="nf">GetHashCode</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DiffInstancesWithSameCtorParamsHaveTheSameHashCode</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">MockType</span> <span class="n">mt1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
        <span class="n">MockType</span> <span class="n">mt3</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">mt1</span><span class="p">.</span><span class="nf">GetHashCode</span><span class="p">(),</span> <span class="n">mt3</span><span class="p">.</span><span class="nf">GetHashCode</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">TestDiffInstancesWithSameCtorParamsAreEqual</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">MockType</span> <span class="n">mt1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
        <span class="n">MockType</span> <span class="n">mt3</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
        <span class="c1">// Objects are equal.
</span>        <span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="n">mt1</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">mt3</span><span class="p">));</span>
        <span class="c1">// References are not equal.
</span>        <span class="n">Assert</span><span class="p">.</span><span class="nf">False</span><span class="p">(</span><span class="kt">object</span><span class="p">.</span><span class="nf">ReferenceEquals</span><span class="p">(</span><span class="n">mt1</span><span class="p">,</span> <span class="n">mt3</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">TestDiffInstancesWithDiffCtorParamsAreNotEqual</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">MockType</span> <span class="n">mt1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockType</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
        <span class="n">MockType</span> <span class="n">mt3</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockType</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
        <span class="c1">// Objects are not equal.
</span>        <span class="n">Assert</span><span class="p">.</span><span class="nf">False</span><span class="p">(</span><span class="n">mt1</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">mt3</span><span class="p">));</span>
        <span class="c1">// References are not equal.
</span>        <span class="n">Assert</span><span class="p">.</span><span class="nf">False</span><span class="p">(</span><span class="kt">object</span><span class="p">.</span><span class="nf">ReferenceEquals</span><span class="p">(</span><span class="n">mt1</span><span class="p">,</span> <span class="n">mt3</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>You can use this class in your component collections. If you want to map a Set (that is, an unordered collection of unique entities where duplicates are not allowed)&#0160;just derive your component types from ComponentBase(Of T).&#0160;Derived types need to implement the&#0160;strongly-typed version of Equals and also the GetHashCode methods.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2010%2F12%2F10%2Fcomponentbase-of-t-class-for-nhibernate-components%2F&text=ComponentBase%28Of+T%29+Class+for+NHibernate+Components&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">December 10, 2010</div><div class="categories">Published in<a class="category" href="/category/nhibernate/">NHibernate&nbsp;</a> on December 10, 2010</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>