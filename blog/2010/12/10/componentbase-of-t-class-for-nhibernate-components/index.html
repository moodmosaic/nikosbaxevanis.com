<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="width=device-width" name="viewport" /><title>ComponentBase(Of T) Class for NHibernate Components</title><link href="/feed" rel="alternate" type="application/rss+xml" /><link href="/stylesheets/blog.css?1390674774" media="screen" rel="stylesheet" type="text/css" /></head><body><div id="title"><div><a href="/blog">moodmosaic</a><span>&nbsp;-&nbsp;</span><a href="/">A modern full-stack programmer's journey and ideas.</a></div><div class="line"></div></div><div id="full"><h2>ComponentBase(Of T) Class for NHibernate Components</h2><div class="undertitle"><a class="tag" href="/blog#nhibernate">nhibernate</a></div><div class="content"><blockquote>
<p>This post aims to provide a way to implement a base class for NHibernate components also known as Value Objects in Domain-driven design.</p>
</blockquote>

<p><img src="http://farm9.staticflickr.com/8494/8398555268_0491f387b3_o.png" alt="" /></p>

<p>In my <a href="http://www.nikosbaxevanis.com/bonus-bits/2010/12/component-collections-in-nhibernate.html" target="_blank" title="Component Collections in NHibernate.">previous post</a> I discussed about the case where you want to map a component with NHibernate and introduced the ComponentBase(Of T) class. However, to make it&#0160;straightforward&#0160;that you need to override Equals (you also need to override GetHashCode) in your derived classes, I modified the ComponentBase(Of T) class to implement the <a href="http://msdn.microsoft.com/en-us/library/ms131187.aspx" target="_blank" title="Defines a generalized method that a value type or class implements to create a type-specific method for determining equality of instances.">IEquatable(Of T)</a> interface.&#0160;Furthermore, since NHibernate works only with reference types (that is, a class) I also constrained it to accept only reference types.</p>

<p>Here is the Component(Of T) class:</p>

<pre><code class="c#">using System;

public abstract class ComponentBase&lt;T&gt; 
    : IEquatable&lt;T&gt; where T : class 
{
    /// &lt;summary&gt;
    /// Indicates whether the current object is equal to another
    /// object of the same type.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;other&quot;&gt;An object to compare with this object.
    /// &lt;/param&gt;
    /// &lt;returns&gt;true if the current object is equal to the other
    /// parameter; otherwise, false.&lt;/returns&gt;
    public abstract bool Equals(T other);

    /// &lt;summary&gt;
    /// Serves as a hash function for a particular type,
    /// suitable for use in hashing
    /// algorithms and data structures such as a hash table.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;
    /// A hash code for this instance of the type.
    /// &lt;/returns&gt;
    public abstract int GetHashCodeForType();

    /// &lt;summary&gt;
    /// Determines whether the specified &lt;see cref=&quot;System.Object&quot;/&gt;
    /// is equal to this instance.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;obj&quot;&gt;The &lt;see cref=&quot;System.Object&quot;/&gt; to
    /// compare with this instance.
    /// &lt;/param&gt;
    /// &lt;returns&gt;
    ///     &lt;c&gt;true&lt;/c&gt; if the specified &lt;see cref=&quot;System.Object&quot;/&gt;
    ///     is equal to this instance;
    ///     otherwise, &lt;c&gt;false&lt;/c&gt;.
    /// &lt;/returns&gt;
    public sealed override bool Equals(object obj)
    {
        // The given object to compare to can&#39;t be null.
        if (obj == null) { return false; }

        // If objects are different types, they can&#39;t be equal.
        if (this.GetType() != obj.GetType()) { return false; }

        return Equals(obj as T);
    }

    /// &lt;summary&gt;
    /// Returns a hash code for this instance.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;
    /// A hash code for this instance, suitable for
    /// use in hashing algorithms and data structures
    /// like a hash table.
    /// &lt;/returns&gt;
    public sealed override int GetHashCode()
    {
        return GetHashCodeForType();
    }
}
</code></pre>

<p>Below are some test cases:</p>

<pre><code class="c#">using System;
using Xunit;

public sealed class ComponentBaseTest
{
    private sealed class MockType 
         : ComponentBase&lt;MockType&gt; { /* ... */ }

    [Fact]
    public void TheSameInstanceHasTheSameHashCode()
    {
        MockType mt1 = new MockType(5);
        MockType mt2 = mt1;
        Assert.Equal(mt1.GetHashCode(), mt2.GetHashCode());
    }

    [Fact]
    public void DiffInstancesWithSameCtorParamsHaveTheSameHashCode()
    {
        MockType mt1 = new MockType(5);
        MockType mt3 = new MockType(5);
        Assert.Equal(mt1.GetHashCode(), mt3.GetHashCode());
    }

    [Fact]
    public void TestDiffInstancesWithSameCtorParamsAreEqual()
    {
        MockType mt1 = new MockType(5);
        MockType mt3 = new MockType(5);
        // Objects are equal.
        Assert.True(mt1.Equals(mt3));
        // References are not equal.
        Assert.False(object.ReferenceEquals(mt1, mt3));
    }

    [Fact]
    public void TestDiffInstancesWithDiffCtorParamsAreNotEqual()
    {
        MockType mt1 = new MockType(1);
        MockType mt3 = new MockType(3);
        // Objects are not equal.
        Assert.False(mt1.Equals(mt3));
        // References are not equal.
        Assert.False(object.ReferenceEquals(mt1, mt3));
    }
}
</code></pre>

<p>You can use this class in your component collections. If you want to map a Set (that is, an unordered collection of unique entities where duplicates are not allowed)&#0160;just derive your component types from ComponentBase(Of T).&#0160;Derived types need to implement the&#0160;strongly-typed version of Equals and also the GetHashCode methods.</p>
</div></div><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'bonusbits';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script></body><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></html>