<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>xUnit.net and AsyncEnumerator to Async and Await</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1392019782" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1392019782" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1392019782" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>xUnit.net and AsyncEnumerator to Async and Await</h1><div class="post"><p>Prior to .NET 4,&#0160;one had to implement the <a href="http://msdn.microsoft.com/en-us/magazine/cc163467.aspx" target="_blank" title="Implementing the CLR Asynchronous Programming Model.">APM</a> model in order to expose asynchronous methods. After a couple of years, the&#0160;<a href="http://msdn.microsoft.com/en-gb/magazine/cc546608.aspx" target="_blank" title="Simplified APM With The AsyncEnumerator.">AsyncEnumerator</a>&#0160;class came out to&#0160;simplify the APM by leveraging the use&#0160;of C# iterators for asynchrony. In the meantime,&#0160;Microsoft developed a&#0160;<a href="http://msdn.microsoft.com/en-us/library/dd460693.aspx" target="_blank" title="Parallel Programming in the .NET Framework.">new</a>&#0160;model for asynchronous (and parallel) programming. Since the new model was targeting the&#0160;.NET 4, code written in previous versions have to keep using the AsyncEnumerator class.</p>

<p>I&#0160;<a href="http://www.nikosbaxevanis.com/bonus-bits/2010/10/an-alternative-net-20-approach-to-the-task-based-asynchronous-pattern.html" target="_blank" title="An alternative (.NET 2.0+) approach to the Task-based Asynchronous Pattern.">have</a>&#0160;<a href="http://www.nikosbaxevanis.com/bonus-bits/2011/07/async-rest-client-for-scrumy-api.html" target="_blank" title="Async REST Client for the Scrumy API.">been</a>&#0160;<a href="http://www.nikosbaxevanis.com/bonus-bits/2010/11/going-asynchronous-with-sterling-for-windows-phone-7.html" target="_blank" title="Going Asynchronous with Sterling for Windows Phone 7.">using</a>&#0160;<a href="http://www.nikosbaxevanis.com/bonus-bits/2010/10/exposing-asynchronous-features-to-client-code-windows-phone-edition.html" target="_blank" title="Exposing asynchronous features to client code: Windows Phone 7.">the</a>&#0160;AsyncEnumerator class since 2008 and it works great. Today we have the new Async and Await keywords in C# 5.0 (together with the <a href="http://blogs.microsoft.co.il/blogs/sasha/archive/2011/09/17/improvements-in-the-clr-core-in-net-framework-4-5.aspx" target="_blank">many</a> <a href="http://blogs.msdn.com/b/dotnet/archive/2011/10/03/large-object-heap-improvements-in-net-4-5.aspx" target="_blank">improvements</a>&#0160;in the CLR) that will ship with .NET 4.5 and the recently added support for&#0160;async unit tests on&#0160;<a href="http://xunit.codeplex.com/releases/view/77573" target="_blank">version 1.9</a>&#0160;of the&#0160;<a href="http://xunit.codeplex.com/" target="_blank" title="xUnit.net is a unit testing tool for the .NET Framework. Written by the original inventor of NUnit, xUnit.net is the latest technology for unit testing C#, F#, VB.NET and other .NET languages.">xUnit.net</a>.&#0160;So, I decided to move some .NET 2.0 code using AsyncEnumerator to .NET 4.5 using Async and Await.</p>

<p>Below is an interface of the sample type (described in <a href="http://msdn.microsoft.com/en-us/magazine/cc163467.aspx" target="_blank" title="Implementing the CLR Asynchronous Programming Model.">this</a> article) exposing both synchronous and asynchronous versions of a time-consuming method:</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IMyType</span>
<span class="p">{</span>
    <span class="c1">// Synchronous version of time-consuming method.
</span>    <span class="n">DateTime</span> <span class="nf">DoSomething</span><span class="p">();</span>

    <span class="c1">// Asynchronous version of time-consuming method (Begin part).
</span>    <span class="n">IAsyncResult</span> <span class="nf">BeginDoSomething</span><span class="p">(</span><span class="n">AsyncCallback</span> <span class="n">callback</span><span class="p">,</span> <span class="kt">object</span> <span class="n">state</span> <span class="p">=</span> <span class="k">null</span><span class="p">);</span>

    <span class="c1">// Asynchronous version of time-consuming method (End part).
</span>    <span class="n">DateTime</span> <span class="nf">EndDoSomething</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">asyncResult</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>A unit test with the AsyncEnumerator can be similar to the one shown below:</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">D</span><span class="p">(</span><span class="n">AsyncEnumerator</span> <span class="n">ae</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>

    <span class="n">sut</span><span class="p">.</span><span class="nf">BeginDoSomething</span><span class="p">(</span><span class="n">ae</span><span class="p">.</span><span class="nf">End</span><span class="p">(),</span> <span class="n">state</span><span class="p">:</span> <span class="k">null</span><span class="p">);</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="nf">EndDoSomething</span><span class="p">(</span><span class="n">ae</span><span class="p">.</span><span class="nf">DequeueAsyncResult</span><span class="p">());</span>
<span class="p">}</span>
</pre>
<p>However, since xUnit.net does not support methods of type IEnumerator&lt;int&gt;, we need to tell xUnit.net how to execute them:</p>
<pre class="highlight csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">D</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Drive the D method's iterator asynchronously.
</span>    <span class="n">var</span> <span class="n">ae</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AsyncEnumerator</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;();</span>
    <span class="n">ae</span><span class="p">.</span><span class="nf">EndExecute</span><span class="p">(</span>
        <span class="n">ae</span><span class="p">.</span><span class="nf">BeginExecute</span><span class="p">(</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">D</span><span class="p">(</span><span class="n">ae</span><span class="p">),</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">}));</span>
<span class="p">}</span>
</pre>
<p>Moving to .NET 4.5 and xUnit.net 1.9 we can create an <a href="http://msdn.microsoft.com/en-us/library/bb383977.aspx" target="_blank" title="Extension methods enable you to &quot;add&quot; methods to existing types without creating a new derived type, recompiling, or otherwise modifying the original type.">Extension Method</a> that returns a <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.task.aspx" target="_blank" title="Represents an asynchronous operation.">Task</a> in order to use both the Async and Await keywords in production code and the async unit tests feature of xUnit.net.</p>
<pre class="highlight csharp"><span class="c1">// Task-based asynchronous version of time-consuming method.
</span><span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;</span> <span class="nf">DoSomethingAsync</span><span class="p">(</span><span class="k">this</span> <span class="n">IMyType</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">FromAsync</span><span class="p">(</span>
        <span class="n">t</span><span class="p">.</span><span class="n">BeginDoSomething</span><span class="p">,</span>
        <span class="n">t</span><span class="p">.</span><span class="n">EndDoSomething</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="k">null</span>
        <span class="p">);</span>
<span class="p">}</span>
</pre>
<p>Now the previous unit test with the AsyncEnumerator can be rewritten as follow:</p>
<pre class="highlight csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="n">async</span> <span class="n">Task</span> <span class="nf">D</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">await</span> <span class="n">sut</span><span class="p">.</span><span class="nf">DoSomethingAsync</span><span class="p">();</span>
<span class="p">}</span>
</pre>
<p>This looks very nice and clean. As it seems though, if the class contains many async unit tests they will not run in parallel.&#0160;</p>

<p>As an example, the following 3 tests will take 3 x 5 = 15 seconds to complete:</p>
<pre class="highlight csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="n">async</span> <span class="n">Task</span> <span class="nf">A</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">await</span> <span class="n">sut</span><span class="p">.</span><span class="nf">DoSomethingAsync</span><span class="p">();</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span> <span class="n">async</span> <span class="n">Task</span> <span class="nf">B</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">await</span> <span class="n">sut</span><span class="p">.</span><span class="nf">DoSomethingAsync</span><span class="p">();</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span> <span class="n">async</span> <span class="n">Task</span> <span class="nf">C</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyType</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">await</span> <span class="n">sut</span><span class="p">.</span><span class="nf">DoSomethingAsync</span><span class="p">();</span>
<span class="p">}</span>
</pre>
<p>The output from xUnit.net:</p>
<pre class="highlight csharp"><span class="n">Output</span> <span class="n">from</span> <span class="n">AsyncUnitTesting</span><span class="p">.</span><span class="n">xUnit</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="n">MyTypeTests</span><span class="p">.</span><span class="n">C</span><span class="p">:</span>
  <span class="n">Started</span>  <span class="m">5</span><span class="p">/</span><span class="m">5</span><span class="p">/</span><span class="m">2012</span> <span class="m">10</span><span class="p">:</span><span class="m">24</span><span class="p">:</span><span class="m">45</span> <span class="n">AM</span>
  <span class="n">Finished</span> <span class="m">5</span><span class="p">/</span><span class="m">5</span><span class="p">/</span><span class="m">2012</span> <span class="m">10</span><span class="p">:</span><span class="m">24</span><span class="p">:</span><span class="m">50</span> <span class="n">AM</span>

<span class="n">Output</span> <span class="n">from</span> <span class="n">AsyncUnitTesting</span><span class="p">.</span><span class="n">xUnit</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="n">MyTypeTests</span><span class="p">.</span><span class="n">B</span><span class="p">:</span>
  <span class="n">Started</span>  <span class="m">5</span><span class="p">/</span><span class="m">5</span><span class="p">/</span><span class="m">2012</span> <span class="m">10</span><span class="p">:</span><span class="m">24</span><span class="p">:</span><span class="m">50</span> <span class="n">AM</span>
  <span class="n">Finished</span> <span class="m">5</span><span class="p">/</span><span class="m">5</span><span class="p">/</span><span class="m">2012</span> <span class="m">10</span><span class="p">:</span><span class="m">24</span><span class="p">:</span><span class="m">55</span> <span class="n">AM</span>

<span class="n">Output</span> <span class="n">from</span> <span class="n">AsyncUnitTesting</span><span class="p">.</span><span class="n">xUnit</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="n">MyTypeTests</span><span class="p">.</span><span class="n">A</span><span class="p">:</span>
  <span class="n">Started</span>  <span class="m">5</span><span class="p">/</span><span class="m">5</span><span class="p">/</span><span class="m">2012</span> <span class="m">10</span><span class="p">:</span><span class="m">24</span><span class="p">:</span><span class="m">50</span> <span class="n">AM</span>
  <span class="n">Finished</span> <span class="m">5</span><span class="p">/</span><span class="m">5</span><span class="p">/</span><span class="m">2012</span> <span class="m">10</span><span class="p">:</span><span class="m">25</span><span class="p">:</span><span class="m">00</span> <span class="n">AM</span>

<span class="m">3</span> <span class="n">passed</span><span class="p">,</span> <span class="m">0</span> <span class="n">failed</span><span class="p">,</span> <span class="m">0</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">took</span> <span class="m">15.26</span> <span class="nf">seconds</span> <span class="p">(</span><span class="n">xUnit</span><span class="p">.</span><span class="n">net</span> <span class="m">1.9</span><span class="p">.</span><span class="m">0</span> <span class="n">build</span> <span class="m">1566</span><span class="p">).</span>
</pre>
<p>That was the part of moving the unit tests from an older version of xUnit.net (and the AsyncEnumerator) to version 1.9 of xUnit.net (with Async and Await).&#0160;Apparently, things become more challenging when moving to production code where one needs to deal with stuff such is the <a href="http://msdn.microsoft.com/en-us/library/system.threading.synchronizationcontext(v=vs.110).aspx" target="_blank" title="Provides the basic functionality for propagating a synchronization context in various synchronization models.">SyncrhonizationContext</a>.</p>

<p>A gist with all the source code can be found&#0160;<a href="https://gist.github.com/2604956" target="_blank">here</a>.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2012%2F05%2F06%2Fxunit-dot-net-and-asyncenumerator-to-async-and-await%2F&text=xUnit.net+and+AsyncEnumerator+to+Async+and+Await&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">May 06, 2012</div><div class="categories">Published in<a class="category" href="/category/xunit.net/">xUnit.net&nbsp;</a><a class="category" href="/category/async/">Async&nbsp;</a><a class="category" href="/category/unit-testing/">Unit Testing&nbsp;</a> on May 06, 2012</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>