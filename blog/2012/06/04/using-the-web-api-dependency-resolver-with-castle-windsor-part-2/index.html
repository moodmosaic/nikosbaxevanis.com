<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Using the Web API Dependency Resolver with Castle Windsor (Part 2)</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1391110042" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1391110042" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1391110042" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Using the Web API Dependency Resolver with Castle Windsor (Part 2)</h1><p><strong>Update</strong>: <a href="http://blog.ploeh.dk/">Mark Seemann</a> has provided a <a href="http://blog.ploeh.dk/2012/10/03/DependencyInjectionInASPNETWebAPIWithCastleWindsor.aspx">solution</a> without using the IDependencyResolver interface.</p>

<blockquote>
<p>The code in this post requires the ASP.NET MVC 4 RC. If you use the Beta version use the code from <a href="http://nikosbaxevanis.com/2012/03/16/using-the-web-api-dependency-resolver-with-castle-windsor/">this</a> post.</p>
</blockquote>

<p>Among the many changes in ASP.NET MVC 4 RC, there is now added support for releasing object graphs, resolved on each request, using dependency scopes.</p>

<p><strong>Creating a dependency scope per request</strong></p>

<p>Since the IHttpControllerFactory interface has been <a href="http://aspnetwebstack.codeplex.com/SourceControl/network/forks/jongalloway/aspnetwebstack/changeset/changes/f6a7f35302ba">removed</a>, the recommendation (from the <a href="http://www.asp.net/whitepapers/mvc4-release-notes#_Toc303253817">release notes</a>) is to use the <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fDispatcher%2fIHttpControllerSelector.cs">IHttpControllerSelector</a> interface to control <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fControllers%2fIHttpController.cs">IHttpController</a> selection and the <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fDispatcher%2fIHttpControllerActivator.cs">IHttpControllerActivator</a> interface to control IHttpController activation.</p>

<p>Below is the IHttpControllerSelector interface:</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IHttpControllerSelector</span>
<span class="p">{</span>
    <span class="n">HttpControllerDescriptor</span> <span class="nf">SelectController</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Other methods removed for brevity.
</span></pre>
<p>And the IHttpControllerActivator interface:</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IHttpControllerActivator</span>
<span class="p">{</span>
    <span class="n">IHttpController</span> <span class="nf">Create</span><span class="p">(</span>
        <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
        <span class="n">HttpControllerDescriptor</span> <span class="n">controllerDescriptor</span><span class="p">,</span> 
        <span class="n">Type</span> <span class="n">controllerType</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>Both interfaces contain method(s) accepting, among others, an <a href="http://goo.gl/jsUg2">HttpRequestMessage</a>. The trick here is to use the HttpRequestMessage&#39;s extension method <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fHttpRequestMessageExtensions.cs">GetDependencyScope</a> for resolving controllers (instead of using a DI Container directly).</p>

<p>Internally, the GetDependencyScope method uses the DependencyResolver (registered in the GlobalConfiguration instance) calling it&#39;s <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fDependencies%2fIDependencyResolver.cs">BeginScope</a> method which <strong>creates a new resolution scope</strong>. Objects that are resolved in that scope are tracked internally. Once the scope is disposed, those objects are released (using the container&#39;s Release method).</p>

<p>Below is an implementation of the IDependencyScope interface:</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Dependencies</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">ReleasingDependencyScope</span> <span class="p">:</span> <span class="n">IDependencyScope</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IDependencyScope</span> <span class="n">scope</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">release</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">instances</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">WindsorDependencyScope</span><span class="p">(</span><span class="n">IDependencyScope</span> <span class="n">scope</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">release</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scope</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;scope&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">release</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;release&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="n">scope</span> <span class="p">=</span> <span class="n">scope</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">release</span> <span class="p">=</span> <span class="n">release</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">instances</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">GetService</span><span class="p">(</span><span class="n">Type</span> <span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">object</span> <span class="n">service</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">scope</span><span class="p">.</span><span class="nf">GetService</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">AddToScope</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">service</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="nf">GetServices</span><span class="p">(</span><span class="n">Type</span> <span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">services</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">scope</span><span class="p">.</span><span class="nf">GetServices</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">AddToScope</span><span class="p">(</span><span class="n">services</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">object</span> <span class="n">instance</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">instances</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">release</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="n">instances</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">AddToScope</span><span class="p">(</span><span class="k">params</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">services</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">instances</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">services</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Having a custom implementation of the <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fDependencies%2fIDependencyScope.cs">IDependencyScope</a> interface, we can now move on with the implementation of the <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fDependencies%2fIDependencyResolver.cs">IDependencyResolver</a> interface. The recommendation (from the <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fDependencies%2fIDependencyResolver.cs">source code</a>) is to return a new instance of IDependencyScope every time the BeginScope method is called.</p>

<p>An implementation of the IDependencyResolver interface for Castle Windsor could be similar to the one below:</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Dependencies</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Castle.Windsor</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">WindsorDependencyResolver</span> <span class="p">:</span> <span class="n">IDependencyResolver</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IWindsorContainer</span> <span class="n">container</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">WindsorDependencyResolver</span><span class="p">(</span><span class="n">IWindsorContainer</span> <span class="n">container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">container</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="n">container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">GetService</span><span class="p">(</span><span class="n">Type</span> <span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="nf">HasComponent</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="nf">Resolve</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="nf">GetServices</span><span class="p">(</span><span class="n">Type</span> <span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="nf">ResolveAll</span><span class="p">(</span><span class="n">t</span><span class="p">).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;().</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IDependencyScope</span> <span class="nf">BeginScope</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReleasingDependencyScope</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">Release</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>As we can see, the BeginScope method returns a new instance of IDependencyScope which can resolve and release objects that belong to that scope.</p>

<p>Moving next, when upgrading from Beta to RC there <em>might</em> be another thing to consider. Since the IHttpControllerFactory interface has now been removed, implementations of that interface were using the <em>controllerName</em> in order to resolve component instances from the DI Containers. As a result, controllers were registered in the DI Containers using names for each registration.</p>

<p>To keep the <em>named</em> registrations (and not break compatibility with any JavaScript clients) we can create a <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fDispatcher%2fDefaultHttpControllerSelector.cs">DefaultHttpControllerSelector</a> derived type and override it&#39;s SelectController method. We can then use the DefaultHttpControllerSelector&#39;s GetControllerName method which returns the requested path name <em>(e.g. &ldquo;Orders&rdquo;)</em>. At that point we can map that name to an <a href="http://aspnetwebstack.codeplex.com/SourceControl/changeset/view/a1b7c04f7227#src%2fSystem.Web.Http%2fApiController.cs">ApiController</a> derived type <em>(ex.: OrderController)</em>.</p>

<p>A DefaultHttpControllerSelector derived type could be similar to the one below:</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Controllers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Dispatcher</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">PluralizedNameHttpControllerSelector</span> <span class="p">:</span> <span class="n">DefaultHttpControllerSelector</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">HttpConfiguration</span> <span class="n">configuration</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Assembly</span> <span class="n">controllerAssembly</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">PluralizedNameHttpControllerSelector</span><span class="p">(</span>
        <span class="n">HttpConfiguration</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">Assembly</span> <span class="n">controllerAssembly</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">configuration</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;configuration&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">controllerAssembly</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;controllerAssembly&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="n">configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">controllerAssembly</span> <span class="p">=</span> <span class="n">controllerAssembly</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">HttpControllerDescriptor</span> <span class="nf">SelectController</span><span class="p">(</span>
        <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">controllerName</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="nf">GetControllerName</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="n">var</span> <span class="n">controllerType</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetControllerType</span><span class="p">(</span><span class="n">controllerName</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">HttpControllerDescriptor</span><span class="p">(</span>
            <span class="k">this</span><span class="p">.</span><span class="n">configuration</span><span class="p">,</span> <span class="n">controllerName</span><span class="p">,</span> <span class="n">controllerType</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Type</span> <span class="nf">GetControllerType</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Look in 'this.controllerAssembly' and find the types that can be
</span>        <span class="c1">// assigned from an instance of IHttpController  and return the one
</span>        <span class="c1">// whose name matches with the given name.
</span>    <span class="p">}</span>
<span class="p">}</span>
</pre>
<blockquote>
<p>Make sure to register the above type in Castle Windsor otherwise the framework will pick it&#39;s default implementation.</p>
</blockquote>

<p>All the above information is the result of browsing the source code on CodePlex. If any  articles or blog posts are released (by the ASP.NET team or individuals) I might create a new post with updates, if necessary.</p>
<a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2012%2F06%2F04%2Fusing-the-web-api-dependency-resolver-with-castle-windsor-part-2%2F&text=Using+the+Web+API+Dependency+Resolver+with+Castle+Windsor+%28Part+2%29&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">June 04, 2012</div><div class="categories">Published in<a class="category" href="/category/web-api/">Web API&nbsp;</a><a class="category" href="/category/castle-windsor/">Castle Windsor&nbsp;</a> on June 04, 2012</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>