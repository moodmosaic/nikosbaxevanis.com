<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Using the Web API Dependency Resolver with Castle Windsor</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1391119947" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1391119948" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1391119948" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Using the Web API Dependency Resolver with Castle Windsor</h1><div class="post"><blockquote>
<p>The code in this post requires the ASP.NET MVC 4 Beta. If you use the RC version use the code from <a href="http://nikosbaxevanis.com/2012/06/04/using-the-web-api-dependency-resolver-with-castle-windsor-part-2/">this</a> post.</p>
</blockquote>

<p><strong>Update</strong>: <a href="http://blog.ploeh.dk">Mark Seemann</a> has provided a <a href="http://blog.ploeh.dk/2012/03/20/RobustDIWithTheASPNETWebAPI.aspx">great post</a> on this subject.
<p>In this post I will discuss a possible solution for having Castle Windsor resolving types for both MVC controllers and Web API controllers. Since the former is well known I will focus mostly on the Web API part.</p>
<p>A team building a mobile web application uses the&nbsp;ASP.NET&nbsp;MVC stack combined with another web services framework. With the release of the Beta version of&nbsp;ASP.NET&nbsp;MVC 4 they decided to give Web API a try (side by side with MVC controllers) and see if it fits their needs.</p>
<p>The&nbsp;<a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.controller.aspx" target="_blank">Controller</a>-derived types are used only for rendering the views (the code is written in JavaScript) while the&nbsp;<a href="http://msdn.microsoft.com/en-us/library/system.web.http.apicontroller(v=vs.108).aspx" target="_blank">ApiController</a>-derived types are used for returning &nbsp;data to the client.</p>
<p>The&nbsp;<a href="http://msdn.microsoft.com/en-us/library/system.web.http.services.dependencyresolver(v=vs.108).aspx" target="_blank">DependencyResolver</a>&nbsp;class provides a method called&nbsp;<a href="http://msdn.microsoft.com/en-us/library/hh834083(v=vs.108).aspx" target="_blank">SetResolver</a>&nbsp;which acts as a registration point for resolving dependencies.</p>
<blockquote>Be careful as there are more than one DependencyResolver types. One defined in System.Web.Mvc namespace and one defined in System.Web.Http namespace. We need the latter here.</blockquote>
<p>Once we define the delegates and set a breakpoint we can see what types the framework requests.</p>
<p>At first an instance of the IHttpControllerFactory type is requested:</p>
<p><img src="http://farm9.staticflickr.com/8506/8397459253_439417138a_o.png" alt="IHttpControllerFactory type is requested" /></p>
<p>Followed by a request for an instance of the ILogger type and so on.</p>
<p><img src="http://farm9.staticflickr.com/8073/8398547788_242021568e_o.png" alt="ILogger type is requested" /></p>
<p>The first thing we want to do is to create a type implementing the IHttpControllerFactory interface.</p></p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Controllers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Dispatcher</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Castle.MicroKernel</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">WindsorHttpControllerFactory</span> <span class="p">:</span> <span class="n">IHttpControllerFactory</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">HttpConfiguration</span> <span class="n">configuration</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IKernel</span> <span class="n">kernel</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">WindsorHttpControllerFactory</span><span class="p">(</span>
        <span class="n">HttpConfiguration</span> <span class="n">configuration</span><span class="p">,</span> 
        <span class="n">IKernel</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">kernel</span> <span class="p">=</span> <span class="n">kernel</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IHttpController</span> <span class="nf">CreateController</span><span class="p">(</span>
        <span class="n">HttpControllerContext</span> <span class="n">controllerContext</span><span class="p">,</span> 
        <span class="kt">string</span> <span class="n">controllerName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">kernel</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IHttpController</span><span class="p">&gt;(</span><span class="n">controllerName</span><span class="p">);</span>

        <span class="n">controllerContext</span><span class="p">.</span><span class="n">Controller</span> <span class="p">=</span> <span class="n">controller</span><span class="p">;</span>
        <span class="n">controllerContext</span><span class="p">.</span><span class="n">ControllerDescriptor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpControllerDescriptor</span><span class="p">(</span>
            <span class="k">this</span><span class="p">.</span><span class="n">configuration</span><span class="p">,</span> 
            <span class="n">controllerName</span><span class="p">,</span> 
            <span class="n">controller</span><span class="p">.</span><span class="nf">GetType</span><span class="p">());</span>

        <span class="k">return</span> <span class="n">controllerContext</span><span class="p">.</span><span class="n">Controller</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">ReleaseController</span><span class="p">(</span><span class="n">IHttpController</span> <span class="n">controller</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">kernel</span><span class="p">.</span><span class="nf">ReleaseComponent</span><span class="p">(</span><span class="n">controller</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Note that inside the WindsorHttpControllerFactory class the CreateController method&nbsp;&nbsp;takes a string for the name of the controller. That means we need to use the Windsor&rsquo;s&nbsp;<em>Named&nbsp;</em>method to set a name for each controller registration. (We can also trim the &ldquo;Controller&rdquo; part from the name and also pluralize the remaining part.)</p>
<pre class="highlight csharp"><span class="k">foreach</span> <span class="p">(</span><span class="n">Type</span> <span class="n">controller</span> <span class="k">in</span> <span class="k">typeof</span><span class="p">(</span><span class="n">OrderController</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetTypes</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=&gt;</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IHttpController</span><span class="p">).</span><span class="nf">IsAssignableFrom</span><span class="p">(</span><span class="n">type</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="c1">// https://github.com/srkirkland/Inflector/
</span>    <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">Inflector</span><span class="p">.</span><span class="nf">Pluralize</span><span class="p">(</span>
        <span class="n">controller</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">&quot;Controller&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">));</span>

    <span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="n">Component</span>
        <span class="p">.</span><span class="nf">For</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Named</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">LifestylePerWebRequest</span><span class="p">());</span>
<span class="p">}</span>
</pre>
<p>Let&rsquo;s also create a NullLogger implementing the ILogger interface.</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Common</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">NullLogger</span> <span class="p">:</span> <span class="n">ILogger</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">category</span><span class="p">,</span> <span class="n">TraceLevel</span> <span class="n">level</span><span class="p">,</span> 
        <span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">messageCallback</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">LogException</span><span class="p">(</span><span class="kt">string</span> <span class="n">category</span><span class="p">,</span> <span class="n">TraceLevel</span> <span class="n">level</span><span class="p">,</span> 
        <span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>For all the other instances that the framework requests there are default implementations in the System.Web.* assemblies and we can now create a Windsor&nbsp;<a href="http://stw.castleproject.org/Default.aspx?Page=Installers&amp;NS=Windsor&amp;AspxAutoDetectCookieSupport=1" target="_blank">Installer</a>&nbsp;to encapsulate the registration logic.</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http.Formatting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Common</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Controllers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Dispatcher</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Metadata</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Metadata.Providers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.ModelBinding</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Castle.MicroKernel.Registration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Castle.MicroKernel.SubSystems.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Castle.Windsor</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">WebApiInstaller</span> <span class="p">:</span> <span class="n">IWindsorInstaller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Install</span><span class="p">(</span><span class="n">IWindsorContainer</span> <span class="n">container</span><span class="p">,</span> <span class="n">IConfigurationStore</span> <span class="n">store</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IHttpControllerFactory</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">WindsorHttpControllerFactory</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleSingleton</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">ILogger</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">NullLogger</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleSingleton</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFormatterSelector</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">FormatterSelector</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleSingleton</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IHttpControllerActivator</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">DefaultHttpControllerActivator</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleTransient</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IHttpActionSelector</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">ApiControllerActionSelector</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleTransient</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IActionValueBinder</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">DefaultActionValueBinder</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleTransient</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IHttpActionInvoker</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">ApiControllerActionInvoker</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleTransient</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">ModelMetadataProvider</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">CachedDataAnnotationsModelMetadataProvider</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">LifestyleTransient</span><span class="p">(),</span>

            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">HttpConfiguration</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">Instance</span><span class="p">(</span><span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>In the&nbsp;Application_Start method we add the installer and set the delegates for the SetResolver method. That way when the framework requests an IHttpControllerFactory instance, Windsor will supply the one we created earlier.</p>
<pre class="highlight csharp"><span class="k">this</span><span class="p">.</span><span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorContainer</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">Install</span><span class="p">(</span><span class="k">new</span> <span class="nf">WebApiInstaller</span><span class="p">());</span>

<span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">ServiceResolver</span><span class="p">.</span><span class="nf">SetResolver</span><span class="p">(</span>
    <span class="n">serviceType</span> <span class="p">=&gt;</span> <span class="n">container</span><span class="p">.</span><span class="nf">Resolve</span><span class="p">(</span><span class="n">serviceType</span><span class="p">),</span>
    <span class="n">serviceType</span> <span class="p">=&gt;</span> <span class="n">container</span><span class="p">.</span><span class="nf">ResolveAll</span><span class="p">(</span><span class="n">serviceType</span><span class="p">).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;());</span>
</pre>
<p>In order to have Windsor resolve regular controllers (side by side) we can create and add another installer as well as an implementation of the IControllerFactory interface.</p>
<pre class="highlight csharp"><span class="k">this</span><span class="p">.</span><span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorContainer</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">Install</span><span class="p">(</span><span class="k">new</span> <span class="nf">WebMvcInstaller</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">Install</span><span class="p">(</span><span class="k">new</span> <span class="nf">WebApiInstaller</span><span class="p">());</span>

<span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">ServiceResolver</span><span class="p">.</span><span class="nf">SetResolver</span><span class="p">(</span>
    <span class="n">serviceType</span> <span class="p">=&gt;</span> <span class="n">container</span><span class="p">.</span><span class="nf">Resolve</span><span class="p">(</span><span class="n">serviceType</span><span class="p">),</span>
    <span class="n">serviceType</span> <span class="p">=&gt;</span> <span class="n">container</span><span class="p">.</span><span class="nf">ResolveAll</span><span class="p">(</span><span class="n">serviceType</span><span class="p">).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;());</span>

<span class="n">ControllerBuilder</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="nf">SetControllerFactory</span><span class="p">(</span>
    <span class="k">new</span> <span class="nf">WindsorControllerFactory</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">));</span>
</pre>
<p>Finally, a&nbsp;gist with all the source code can be found <a href="https://gist.github.com/2044349" target="_blank">here</a>.</p>

<p>References:</p>

<ul>
<li><a href="http://forums.asp.net/t/1770736.aspx/" target="_blank">Web Api / Implementing IHttpControllerFactory.CreateController</a></li>
<li><a href="http://forums.asp.net/t/1772519.aspx/" target="_blank">Web Api /&nbsp;How do I use Windsor?</a></li>
</ul>

<ul>
</ul>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2012%2F03%2F16%2Fusing-the-web-api-dependency-resolver-with-castle-windsor%2F&text=Using+the+Web+API+Dependency+Resolver+with+Castle+Windsor&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">March 16, 2012</div><div class="categories">Published in<a class="category" href="/category/web-api/">Web API&nbsp;</a><a class="category" href="/category/castle-windsor/">Castle Windsor&nbsp;</a> on March 16, 2012</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>