<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Dynamic Proxy overriding Equals in AutoFixture Likeness</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1391119947" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1391119948" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1391119948" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Dynamic Proxy overriding Equals in AutoFixture Likeness</h1><div class="post"><p>From version 2.9.0 of AutoFixture, the&nbsp;<a href="http://blog.ploeh.dk/2010/06/29/IntroducingAutoFixtureLikeness.aspx" target="_blank">Likeness</a>&nbsp;class contains a new feature for&nbsp;creating a dynamic proxy that overrides Equals on the destination type.</p>

<p>As an example, we want to compare instances of the following types:</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">DoubleParameterType</span><span class="p">&lt;</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">DoubleParameterType</span><span class="p">(</span><span class="n">T1</span> <span class="n">parameter1</span><span class="p">,</span> <span class="n">T2</span> <span class="n">parameter2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Parameter1</span> <span class="p">=</span> <span class="n">parameter1</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Parameter2</span> <span class="p">=</span> <span class="n">parameter2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">T1</span> <span class="n">Parameter1</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">T2</span> <span class="n">Parameter2</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">SingleParameterType</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SingleParameterType</span><span class="p">(</span><span class="n">T</span> <span class="n">parameter</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Parameter</span> <span class="p">=</span> <span class="n">parameter</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">T</span> <span class="n">Parameter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>We can have the following syntax (prior to version 2.9.0):</p>
<pre class="highlight csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">TestWithLikeness</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Fixture setup
</span>    <span class="n">var</span> <span class="k">value</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoubleParameterType</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">double</span><span class="p">&gt;(</span><span class="m">1</span><span class="p">,</span> <span class="m">2.0</span><span class="p">);</span>

    <span class="n">Likeness</span><span class="p">&lt;</span><span class="n">DoubleParameterType</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">double</span><span class="p">&gt;,</span> <span class="n">SingleParameterType</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="n">sut</span> 
        <span class="p">=</span> <span class="k">value</span><span class="p">.</span><span class="nf">AsSource</span><span class="p">()</span>
               <span class="p">.</span><span class="n">OfLikeness</span><span class="p">&lt;</span><span class="n">SingleParameterType</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;();</span>

    <span class="c1">// Exercise system
</span>    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="c1">// Verify outcome
</span>    <span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>However, from version 2.9.0 there is also a new CreateProxy method on Likeness which returns a proxy of the destination type overriding Equals with Likeness&rsquo;s instance of IEqualityComparer&nbsp;(the SemanticComparer class):</p>
<pre class="highlight csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">TestWithLikenessProxy</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Fixture setup
</span>    <span class="n">var</span> <span class="k">value</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoubleParameterType</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">double</span><span class="p">&gt;(</span><span class="m">1</span><span class="p">,</span> <span class="m">2.0</span><span class="p">);</span>

    <span class="n">SingleParameterType</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">sut</span>
        <span class="p">=</span> <span class="k">value</span><span class="p">.</span><span class="nf">AsSource</span><span class="p">()</span>
               <span class="p">.</span><span class="n">OfLikeness</span><span class="p">&lt;</span><span class="n">SingleParameterType</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;()</span>
               <span class="p">.</span><span class="nf">CreateProxy</span><span class="p">();</span>

    <span class="c1">// Exercise system
</span>    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="c1">// Verify outcome
</span>    <span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>Below is also an example, where we need to verify that an expectation was met:</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Bar</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Zip</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Bar</span> <span class="n">Bar</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">DoSomething</span><span class="p">(</span><span class="n">ISomeContext</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Bar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Bar</span> <span class="p">{</span> <span class="n">Zip</span> <span class="p">=</span> <span class="s">&quot;12345&quot;</span> <span class="p">};</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">DoSomething</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Bar</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">ISomeContext</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">DoSomething</span><span class="p">(</span><span class="kt">object</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Test</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Foo</span><span class="p">();</span>
    <span class="n">var</span> <span class="n">ctx</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">ISomeContext</span><span class="p">&gt;();</span>
    <span class="n">foo</span><span class="p">.</span><span class="nf">DoSomething</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="n">var</span> <span class="n">bar</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bar</span><span class="p">().</span><span class="nf">AsSource</span><span class="p">().</span><span class="n">OfLikeness</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;().</span><span class="nf">CreateProxy</span><span class="p">();</span>
    <span class="n">bar</span><span class="p">.</span><span class="n">Zip</span> <span class="p">=</span> <span class="s">&quot;12345&quot;</span><span class="p">;</span>

    <span class="n">ctx</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">DoSomething</span><span class="p">(</span><span class="n">bar</span><span class="p">));</span>
<span class="p">}</span>
</pre>
<p>Although the new Bar instance is created inside the DoSomething method, we can pass a <em>proxied </em>Bar instance on the mock&rsquo;s Verify method.</p>

<p>Internally, a custom Proxy Generator was written which also&nbsp;supports types with non-parameterless constructors.&nbsp;In order to create proxies of such types, the values from the source have to be compatible with the parameters on the destination constructor.&nbsp;(The mapping between the two is made possible by using the same semantic heuristics, as the default semantic comparison.)</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2012%2F02%2F20%2Fdynamic-proxy-overriding-equals-in-autofixture-likeness%2F&text=Dynamic+Proxy+overriding+Equals+in+AutoFixture+Likeness&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">February 20, 2012</div><div class="categories">Published in<a class="category" href="/category/autofixture/">AutoFixture&nbsp;</a> on February 20, 2012</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>