<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Parameterized Tests for ServiceStack Web Services</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1397091658" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1397091658" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Parameterized Tests for ServiceStack Web Services</h1><div class="post"><p>I have been using ServiceStack&#39;s <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.ServiceInterface/RestServiceBase.cs" target="_blank">RestServiceBase</a>&#0160;class with great success.&#0160;Because of that I started looking for ways to automate a <a href="http://xunitpatterns.com/Layer%20Test.html" target="_blank" title="Also known as: Single Layer Test, Testing by Layers, Layered Test.">Layer Test</a> for a simple scenario where a&#0160;client requests a representation of a resource using GET and/or submits data to be processed to the identified resource using POST.</p>
<pre class="highlight text">public class CategoryService : RestServiceBase&lt;Category&gt;
{
    public override object OnGet(Category request)  { /* ... */ }
    public override object OnPost(Category request) { /* ... */ }
}
</pre>
<p>I found a very nice&#0160;<a href="https://github.com/ServiceStack/ServiceStack/wiki/HowTo-write-unit-integration-tests" target="_blank">entry</a> on the wiki and after writting a couple of tests I realized that I was repating the following steps over and over:</p>

<ul>
<li>Copy the base URI on each test case.</li>
<li>Create a new instance of the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Common/ServiceClient.Web/JsonServiceClient.cs" target="_blank">JsonRestClient</a> class (and preferably cast to <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Service/IRestClient.cs" target="_blank">IRestClient</a>).</li>
</ul>
<pre class="highlight text">var restClient = (IRestClient)new JsonServiceClient(&quot;http://localhost:5000&quot;);
</pre>
<p>One solution is to have the base URI (and even the IRestClient) on a private field inside the test class and use it from all tests.&#0160;However, a better approach would be to write&#0160;<a href="http://xunitpatterns.com/Parameterized%20Test.html" target="_blank">Parameterized Tests</a>&#0160;that accept an instance of the IRestClient type.</p>

<p>Fortunately, this can be done using xUnit.net data theories. Furthermore, since the IRestClient is an interface, this is a great scenario for using <a href="http://autofixture.codeplex.com/" target="_blank" title="AutoFixture makes it easier for developers to do Test-Driven Development by automating non-relevant Test Fixture Setup, allowing the Test Developer to focus on the essentials of each test case.">AutoFixture</a>&#0160;together&#0160;<a href="http://blog.ploeh.dk/2010/10/08/AutoDataTheoriesWithAutoFixture.aspx" target="_blank">with</a> xUnit.net data theories <a href="http://www.nikosbaxevanis.com/bonus-bits/2011/12/auto-mocking-with-fakeiteasy-and-autofixture.html" target="_blank">and</a>&#0160;auto mocking.</p>

<p>Below is a parameterized test:</p>
<pre class="highlight text">
[Theory, AutoWebData]
public void HttpGetReturnsnNonEmptyResult(IRestClient sut)
{
    var results = sut.Get&lt;Category[]&gt;(&quot;/categories&quot;);
    Assert.True(results.Any());
}
[Theory, AutoWebData]
public void HttpGetReturnsNonEmptyResultWithId(IRestClient sut)
{
    var expectedId = sut.Get&lt;Category[]&gt;(&quot;/categories&quot;).First().Id;
    var result = sut.Get&lt;Category&gt;(&quot;/categories/&quot; + expectedId);
    Assert.Equal(expectedId, result.Id);
}
</pre>
<p>The <em>AutoWebData </em>attribute provides auto-generated data specimens generated by AutoFixture as an extention to xUnit.net&#39;s Theory attribute.</p>
<pre class="highlight text">public sealed class AutoWebDataAttribute : AutoDataAttribute
{
    public AutoWebDataAttribute()
        : base(new Fixture().Customize(new WebModelCustomization()))
    {
    }
}
</pre>
<p>Inside this attribute class we also pass a new instance of the Fixture class <em>customized </em>in order to supply an instance of the JsonServiceClient when an IRestClient is requested. (You can read more about AutoFixture Customizations&#0160;<a href="http://megakemp.wordpress.com/2011/12/15/keep-your-unit-tests-dry-with-autofixture-customizations/" target="_blank" title="Keep your unit tests DRY with AutoFixture Customizations.">here</a>.)</p>
<pre class="highlight text">public class WebModelCustomization : CompositeCustomization
{
    public WebModelCustomization()
        : base(
            new RestClientCustomization(),
            new AutoMoqCustomization()) { } 

    private sealed class RestClientCustomization : ICustomization
    {
        public void Customize(IFixture fixture)
        {
            fixture.Inject&lt;IRestClient&gt;(
                new JsonServiceClient(&quot;http://localhost:5000&quot;));
        }
    }
}
</pre>
<p>The advantage of this approach is that we have abstracted the creation of the IRestClient instance from the test itself. The base URI is now hardcoded in only one place (the customization class). Furthermore, we can easily pass other parameters to the test method if necessary.&#0160;</p>

<p>While this approach is applied to ServiceStack it can be easily generalized and used on other scenarios as well.</p>
</div><div class="footer"><div class="author"><h4>Written by Nikos Baxevanis</h4></div><p>Programmer, building software in a broad range of sectors and technologies. Find me here: <a href="http://twitter.com/nikosbaxevanis">http://twitter.com/nikosbaxevanis</a></p></p></div><div class="dater">February 18, 2012</div><div class="categories">Published in<a class="category" href="/category/unit-testing/">Unit Testing&nbsp;</a><a class="category" href="/category/autofixture/">AutoFixture&nbsp;</a></div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>