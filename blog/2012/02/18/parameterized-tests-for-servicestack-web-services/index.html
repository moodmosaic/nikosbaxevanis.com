<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Parameterized Tests for ServiceStack Web Services</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1392287228" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1392287228" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1392287228" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Parameterized Tests for ServiceStack Web Services</h1><div class="post"><p>I have been using ServiceStack&#39;s <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.ServiceInterface/RestServiceBase.cs" target="_blank">RestServiceBase</a>&#0160;class with great success.&#0160;Because of that I started looking for ways to automate a <a href="http://xunitpatterns.com/Layer%20Test.html" target="_blank" title="Also known as: Single Layer Test, Testing by Layers, Layered Test.">Layer Test</a> for a simple scenario where a&#0160;client requests a representation of a resource using GET and/or submits data to be processed to the identified resource using POST.</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">CategoryService</span> <span class="p">:</span> <span class="n">RestServiceBase</span><span class="p">&lt;</span><span class="n">Category</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="kt">object</span> <span class="nf">OnGet</span><span class="p">(</span><span class="n">Category</span> <span class="n">request</span><span class="p">)</span>  <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">override</span> <span class="kt">object</span> <span class="nf">OnPost</span><span class="p">(</span><span class="n">Category</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>I found a very nice&#0160;<a href="https://github.com/ServiceStack/ServiceStack/wiki/HowTo-write-unit-integration-tests" target="_blank">entry</a> on the wiki and after writting a couple of tests I realized that I was repating the following steps over and over:</p>

<ul>
<li>Copy the base URI on each test case.</li>
<li>Create a new instance of the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Common/ServiceClient.Web/JsonServiceClient.cs" target="_blank">JsonRestClient</a> class (and preferably cast to <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Service/IRestClient.cs" target="_blank">IRestClient</a>).</li>
</ul>
<pre class="highlight csharp"><span class="n">var</span> <span class="n">restClient</span> <span class="p">=</span> <span class="p">(</span><span class="n">IRestClient</span><span class="p">)</span><span class="k">new</span> <span class="nf">JsonServiceClient</span><span class="p">(</span><span class="s">&quot;http://localhost:5000&quot;</span><span class="p">);</span>
</pre>
<p>One solution is to have the base URI (and even the IRestClient) on a private field inside the test class and use it from all tests.&#0160;However, a better approach would be to write&#0160;<a href="http://xunitpatterns.com/Parameterized%20Test.html" target="_blank">Parameterized Tests</a>&#0160;that accept an instance of the IRestClient type.</p>

<p>Fortunately, this can be done using xUnit.net data theories. Furthermore, since the IRestClient is an interface, this is a great scenario for using <a href="http://autofixture.codeplex.com/" target="_blank" title="AutoFixture makes it easier for developers to do Test-Driven Development by automating non-relevant Test Fixture Setup, allowing the Test Developer to focus on the essentials of each test case.">AutoFixture</a>&#0160;together&#0160;<a href="http://blog.ploeh.dk/2010/10/08/AutoDataTheoriesWithAutoFixture.aspx" target="_blank">with</a> xUnit.net data theories <a href="http://www.nikosbaxevanis.com/bonus-bits/2011/12/auto-mocking-with-fakeiteasy-and-autofixture.html" target="_blank">and</a>&#0160;auto mocking.</p>

<p>Below is a parameterized test:</p>
<pre class="highlight csharp">
<span class="na">[Theory, AutoWebData]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">HttpGetReturnsnNonEmptyResult</span><span class="p">(</span><span class="n">IRestClient</span> <span class="n">sut</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">results</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Category</span><span class="p">[</span><span class="k">]&gt;</span><span class="p">(</span><span class="s">&quot;/categories&quot;</span><span class="p">);</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="nf">Any</span><span class="p">());</span>
<span class="p">}</span>
<span class="na">[Theory, AutoWebData]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">HttpGetReturnsNonEmptyResultWithId</span><span class="p">(</span><span class="n">IRestClient</span> <span class="n">sut</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">expectedId</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Category</span><span class="p">[</span><span class="k">]&gt;</span><span class="p">(</span><span class="s">&quot;/categories&quot;</span><span class="p">).</span><span class="nf">First</span><span class="p">().</span><span class="n">Id</span><span class="p">;</span>
    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Category</span><span class="p">&gt;(</span><span class="s">&quot;/categories/&quot;</span> <span class="p">+</span> <span class="n">expectedId</span><span class="p">);</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">expectedId</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>The <em>AutoWebData </em>attribute provides auto-generated data specimens generated by AutoFixture as an extention to xUnit.net&#39;s Theory attribute.</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">AutoWebDataAttribute</span> <span class="p">:</span> <span class="n">AutoDataAttribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">AutoWebDataAttribute</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">new</span> <span class="nf">Fixture</span><span class="p">().</span><span class="nf">Customize</span><span class="p">(</span><span class="k">new</span> <span class="nf">WebModelCustomization</span><span class="p">()))</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Inside this attribute class we also pass a new instance of the Fixture class <em>customized </em>in order to supply an instance of the JsonServiceClient when an IRestClient is requested. (You can read more about AutoFixture Customizations&#0160;<a href="http://megakemp.wordpress.com/2011/12/15/keep-your-unit-tests-dry-with-autofixture-customizations/" target="_blank" title="Keep your unit tests DRY with AutoFixture Customizations.">here</a>.)</p>
<pre class="highlight csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">WebModelCustomization</span> <span class="p">:</span> <span class="n">CompositeCustomization</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">WebModelCustomization</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span>
            <span class="k">new</span> <span class="nf">RestClientCustomization</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nf">AutoMoqCustomization</span><span class="p">())</span> <span class="p">{</span> <span class="p">}</span> 

    <span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">RestClientCustomization</span> <span class="p">:</span> <span class="n">ICustomization</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Customize</span><span class="p">(</span><span class="n">IFixture</span> <span class="n">fixture</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">fixture</span><span class="p">.</span><span class="n">Inject</span><span class="p">&lt;</span><span class="n">IRestClient</span><span class="p">&gt;(</span>
                <span class="k">new</span> <span class="nf">JsonServiceClient</span><span class="p">(</span><span class="s">&quot;http://localhost:5000&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The advantage of this approach is that we have abstracted the creation of the IRestClient instance from the test itself. The base URI is now hardcoded in only one place (the customization class). Furthermore, we can easily pass other parameters to the test method if necessary.&#0160;</p>

<p>While this approach is applied to ServiceStack it can be easily generalized and used on other scenarios as well.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2012%2F02%2F18%2Fparameterized-tests-for-servicestack-web-services%2F&text=Parameterized+Tests+for+ServiceStack+Web+Services&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">February 18, 2012</div><div class="categories">Published in<a class="category" href="/category/unit-testing/">Unit Testing&nbsp;</a><a class="category" href="/category/autofixture/">AutoFixture&nbsp;</a> on February 18, 2012</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>