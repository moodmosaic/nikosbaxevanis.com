<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Exercising the SUT asynchronously</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1401783646" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1401783646" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Exercising the SUT asynchronously</h1><div class="post"><p>In unit testing, there are times were the <a href="http://xunitpatterns.com/SUT.html">SUT</a> has to be exercised <strong>asynchronously</strong>.</p>

<p>How can we wait for the exercise to complete execution?</p>

<ul>
<li>An instance of the SUT can be created on the main thread.</li>
<li>The main <em>(waiting)</em> thread <strong>spins in user mode</strong> while starting the exercise of the SUT asynchronously.</li>
<li>Once the result has been received, the execution continues on the main thread.</li>
<li>The assertion takes place.</li>
</ul>

<p>The <a href="http://msdn.microsoft.com/en-us/library/system.threading.spinwait.aspx">SpinWait</a> synchronization type contains a method named <a href="http://msdn.microsoft.com/en-us/library/system.threading.spinwait.spinuntil.aspx">SpinUntil</a> which works perfect for the described scenario.</p>
<pre class="highlight text">// Fixture setup
var sut = new ObjectLocalStorage();
sut.Set(@object, expected);
object result = null;

// Exercise system
new Task(() =&gt; result = sut.Get(@object)).Start();
SpinWait.SpinUntil(() =&gt; result != null);

// Verify outcome
Assert.Equal(expected, result);
// Teardown
</pre>
<ul>
<li>Once the <code>Task</code> has been created it is immediately scheduled for execution by calling the <code>Start</code> method.</li>
<li>As long as the unit test runs fast, the waiting thread spins in user mode, which is a <a href="http://msdn.microsoft.com/en-us/library/ee722114.aspx">good thing</a>.</li>
</ul>

<p>There is also a <a href="http://msdn.microsoft.com/en-us/library/dd449238.aspx">SpinUntil overload</a> accepting a TimeSpan timeout.</p>
</div><div class="dater">October 28, 2012</div><div class="categories">Published in<a class="category" href="/category/unit-testing/">Unit Testing&nbsp;</a></div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>