<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="width=device-width" name="viewport" /><title>Database Schema Synchronization with SqlPackage.exe</title><link href="/images/favicon.ico" rel="icon" type="image/x-icon" /><link href="/feed" rel="alternate" type="application/rss+xml" /><link href="/stylesheets/blog.css?1388878489" media="screen" rel="stylesheet" type="text/css" /></head><body><body><div id="title"><div><h1><a href="/blog" style="color: #222">moodmosaic</a></h1><div><span>by </span><a href="/">Nikos Baxevanis </a><a href="http://creativecommons.org/licenses/by/3.0/" style="color: #877">(license)</a></div></div><div class="line"></div></div><div id="full"><h1><a>Database Schema Synchronization with SqlPackage.exe</a></h1><div class="undertitle"><span class="date">Filed under </span><a class="tag" href="/blog#visual-studio">visual-studio</a></div><p><a href="http://msdn.microsoft.com/en-us/library/hh550080.aspx">SqlPackage</a> is the descendant of <a href="http://msdn.microsoft.com/en-us/library/dd193283.aspx">VsDbCmd</a> command-line tool. It creates, deploys, and packages SQL Server databases snapshots into a portable artifact called a DAC package, also known as a DACPAC.</p>

<p><strong>Manual Database Schema Synchronization</strong></p>

<ul>
<li>Create a New <code>SQL Server Database Project</code></li>
<li>On the newly created SQL Server Database Project:

<ul>
<li>Right Click, Import, Database&hellip;</li>
<li>Right Click, Properties</li>
<li>In the Project Settings tab select target platform <em>(e.g. SQL Server 2008)</em></li>
<li>In the SQLCMD Variables tab enter in the <code>Local</code> column the path of SQL Server installation folder. Notice that the Local path overrides the <code>Default</code> path.</li>
</ul></li>
<li>Go to <code>SQL &gt; Schema Compare &gt; New Schema Comparison</code>

<ul>
<li>Select as source the newly created SQL Server Database Project.</li>
<li>Select as target the database containing the schema to be synchronized.</li>
</ul></li>
</ul>

<p><strong>Automatic Database Schema Synchronization</strong></p>

<p>When there is no network access in production environment, the synchronization process can be automated.</p>

<p>Thanks to <a href="mailto:jimikar@gmail.com">Dimitris Charalampidis</a> who provided the steps below, the database schema synchronization can be automated as follows:</p>

<ul>
<li>Copy the created &#39;.dacpac&#39; file from SQL Server Database Project build output path to the same folder as SqlPackage.</li>
<li>Open a command console and execute the following command:</li>
</ul>

<pre><code>sqlpackage.exe 
  /a:Script 
  /sf:[Yourdatabaseproject.dacpac] 
  /tcs:&quot;Data Source=[connectionString]&quot;
  /op:DBSchemaCompareScript.sql 
  /p:ScriptDeployStateChecks=True 
  /p:BackupDatabaseBeforeChanges=True
  /p:IgnoreExtendedProperties=True
  /p:IgnorePermissions=True 
  /p:IgnoreRoleMembership=True 
  /v:Path1=&quot;[Path1]&quot; 
  /v:Path2=&quot;[Path2]&quot;
</code></pre>

<ul>
<li>Replace:

<ul>
<li>[Yourdatabaseproject.dacpac] with the database project snapshot name you copied in the folder earlier.</li>
<li>[connectionString] with the database connection string.</li>
<li>[Path1] and [Path2] with the path to the SQL Server installation folder.</li>
</ul></li>
</ul>

<blockquote>
<p>At this point you may want to add also the <code>/p:GenerateSmartDefaults=True</code> switch to provide a default value when updating a table that contains data with for columns that do not allow null values.</p>
</blockquote>

<p>After a few seconds a file named <em>DBSchemaCompareScript.sql</em> will be created (you can change the name with the <code>/op:</code> switch value).</p>

<ul>
<li>Open the script file with Microsoft SQL Server Management Studio.</li>
<li>Select <code>Query &gt; SQLCMD Mode</code> and execute the query.</li>
</ul>

<p>After the query executes without errors, the database schema will be synchronized with the latest changes.</p>

<p><strong>Remarks</strong></p>

<p>The following files are required by the SqlPackage if the <a href="http://msdn.microsoft.com/en-us/data/tools.aspx">Microsoft SQL Server Data Tools</a> is not installed in production environment:</p>

<ul>
<li>SqlPackage.exe</li>
<li>Microsoft.Data.Tools.Schema.Sql.dll</li>
<li>Microsoft.Data.Tools.Utilities.dll</li>
<li>Microsoft.SqlServer.Dac.dll</li>
<li>Microsoft.SqlServer.TransactSql.ScriptDom.dll</li>
</ul>
</div><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'bonusbits';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script></body><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>