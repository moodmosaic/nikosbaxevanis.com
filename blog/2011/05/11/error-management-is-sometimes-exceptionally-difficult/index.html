<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Error Management Is Sometimes Exceptionally Difficult</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1392663641" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1392663641" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1392663641" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Error Management Is Sometimes Exceptionally Difficult</h1><div class="post"><p><strong>Update:&nbsp;</strong>&nbsp;Please also read <a title="Enterprise Library IContainerConfigurator implementation for Windsor" href="http://www.nikosbaxevanis.com/bonus-bits/2011/05/enterpriselibrary-and-windsorcontainerconfigurator.html" target="_blank">Part 2</a>. The source <del>is on github</del> has been <a href="http://entlibcontrib.codeplex.com/SourceControl/changeset/63545">merged</a> in Enterprise Library Contrib.</p>

<p>I tend to simplify exception handling at layer boundaries, when&nbsp;designing a distributed application. Most of the time if an exception is propagated there I try to apply some kind of policy in order to log the exception and then re-throw&nbsp;&nbsp;a different exception.</p>

<p>When I started using the<span>&nbsp;Exception Handling Application Block from Enterprise Library I found out that I had to also deploy the Unity assemblies. </span></p>

<p><span>The call below resolves the registered component for the ExceptionManager class:</span></p>
<pre class="highlight csharp"><span class="n">EnterpriseLibraryContainer</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">ExceptionManager</span><span class="p">&gt;();</span>
</pre>
<p>The IServiceLocator.Current property of EnterpriseLibraryContainer class sets by default the Unity container (via UnityServiceLocator adapter class).</p>

<p><img src="http://farm9.staticflickr.com/8508/8398554996_e06fa74d80_b.jpg" alt="" /></p>

<p>In fact, if I remove the Unity assemblies a FileNotFoundException is thrown, indicating that&nbsp;Microsoft.Practices.Unity assembly or one of its dependencies could not be found.</p>

<p>Since I use Windsor in that application I didn&rsquo;t like the fact that I had to deploy it with two different IoC containers (!) so I started figuring out how I can call tell the EnterpriseLibraryContainer to resolve the ExceptionManager component using Windsor.</p>

<p>The first thing I did was to compile the&nbsp;<a title="Castle Windsor Adapter - CommonServiceLocator" href="http://commonservicelocator.codeplex.com/wikipage?title=Castle%20Windsor%20Adapter&amp;referringTitle=Home" target="_blank">Windsor adapter</a> of the CommonServiceLocator against the current version of Windsor that I use (and also run the unit-tests and see if they pass).</p>

<p>Next, I set the IServiceLocator.Current property of the EnterpriseLibraryContainer class:</p>
<pre class="highlight csharp"><span class="n">EntLibraryContainer</span><span class="p">.</span><span class="n">Current</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorServiceLocator</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>
</pre>
<p>The last thing I did was to call the ConfigureContainer method on the EnterpriseLibraryContainer class. This method takes an&nbsp;IContainerConfigurator and an IConfigurationSource as parameters.</p>

<p>Great, so I had to provide a class implementing the IContainerConfigurator interface for the Windsor container.</p>

<p>The IContainerConfigurator interface contains a single method:&nbsp;</p>
<pre class="highlight csharp"><span class="k">void</span> <span class="nf">RegisterAll</span><span class="p">(</span>
     <span class="n">IConfigurationSource</span> <span class="n">configurationSource</span><span class="p">,</span>        
     <span class="n">ITypeRegistrationsProvider</span> <span class="n">rootProvider</span>
     <span class="p">);</span>
</pre>
<p>Below is the (currently incomplete) implementation:</p>
<pre class="highlight csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq.Expressions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Castle.MicroKernel.Registration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Castle.Windsor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Practices.EnterpriseLibrary.Common.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Practices.EnterpriseLibrary.Common.Configuration.ContainerModel</span><span class="p">;</span>

<span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">WindsorContainerConfigurator</span>
    <span class="p">:</span> <span class="n">IContainerConfigurator</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IWindsorContainer</span> <span class="n">container</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">WindsorContainerConfigurator</span><span class="p">(</span><span class="n">IWindsorContainer</span> <span class="n">container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RegisterAll</span><span class="p">(</span>
        <span class="n">IConfigurationSource</span> <span class="n">configurationSource</span><span class="p">,</span>
        <span class="n">ITypeRegistrationsProvider</span> <span class="n">rootProvider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">TypeRegistration</span> <span class="n">registration</span> 
            <span class="k">in</span> <span class="n">rootProvider</span><span class="p">.</span><span class="nf">GetRegistrations</span><span class="p">(</span><span class="n">configurationSource</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="nf">Register</span><span class="p">(</span><span class="n">registration</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Register</span><span class="p">(</span><span class="n">TypeRegistration</span> <span class="n">registration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Type</span> <span class="n">implementation</span> <span class="p">=</span> <span class="n">registration</span><span class="p">.</span><span class="n">ImplementationType</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="nf">HasComponent</span><span class="p">(</span><span class="n">implementation</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">var</span> <span class="n">componentRegistration</span> <span class="p">=</span>
                <span class="n">Component</span><span class="p">.</span><span class="nf">For</span><span class="p">(</span><span class="n">registration</span><span class="p">.</span><span class="n">ServiceType</span><span class="p">)</span>
                            <span class="p">.</span><span class="nf">ImplementedBy</span><span class="p">(</span><span class="n">implementation</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">registration</span><span class="p">.</span><span class="n">ConstructorParameters</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">var</span> <span class="n">dependencies</span> <span class="p">=</span> <span class="nf">GetRegistrationDependencies</span><span class="p">(</span>
                    <span class="n">componentRegistration</span><span class="p">,</span> 
                    <span class="n">registration</span><span class="p">.</span><span class="n">ConstructorParameters</span><span class="p">);</span>

                <span class="n">componentRegistration</span> <span class="p">=</span> 
                    <span class="n">componentRegistration</span><span class="p">.</span><span class="nf">DependsOn</span><span class="p">(</span><span class="n">dependencies</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nf">AddLifeStyleToRegistration</span><span class="p">(</span>
                <span class="n">componentRegistration</span><span class="p">,</span> <span class="n">registration</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">IDictionary</span> <span class="n">GetRegistrationDependencies</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">&gt;(</span>
        <span class="n">ComponentRegistration</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">&gt;</span> <span class="n">registration</span><span class="p">,</span>
        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ParameterValue</span><span class="p">&gt;</span> <span class="n">constructorParameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">dependencies</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Hashtable</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="n">ParameterValue</span> <span class="n">pv</span> <span class="k">in</span> <span class="n">constructorParameters</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">MemberExpression</span> <span class="n">exp</span> <span class="p">=</span> <span class="n">pv</span><span class="p">.</span><span class="n">Expression</span>
                <span class="k">as</span> <span class="n">MemberExpression</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="n">exp</span><span class="p">.</span><span class="n">Member</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
                <span class="kt">object</span> <span class="n">val</span> <span class="p">=</span> <span class="nf">GetValue</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

                <span class="n">dependencies</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// TODO: pv.Expression is a MethodCallExpression.
</span>            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">dependencies</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">ComponentRegistration</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">&gt;</span> <span class="n">AddLifeStyleToRegistration</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">&gt;(</span>
        <span class="n">ComponentRegistration</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">&gt;</span> <span class="n">registration</span><span class="p">,</span> 
        <span class="n">TypeRegistrationLifetime</span> <span class="n">typeRegistrationLifetime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">typeRegistrationLifetime</span> <span class="p">==</span> 
            <span class="n">TypeRegistrationLifetime</span><span class="p">.</span><span class="n">Singleton</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">registration</span> <span class="p">=</span> <span class="n">registration</span><span class="p">.</span><span class="n">LifeStyle</span><span class="p">.</span><span class="n">Singleton</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">typeRegistrationLifetime</span> <span class="p">==</span> 
            <span class="n">TypeRegistrationLifetime</span><span class="p">.</span><span class="n">Transient</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">registration</span> <span class="p">=</span> <span class="n">registration</span><span class="p">.</span><span class="n">LifeStyle</span><span class="p">.</span><span class="n">Transient</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span>
                <span class="s">&quot;typeRegistrationLifetime&quot;</span><span class="p">,</span> 
                <span class="s">&quot;Only Transient and Singleton are supported.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">registration</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">object</span> <span class="nf">GetValue</span><span class="p">(</span><span class="n">Expression</span> <span class="n">member</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">objectMember</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Convert</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">object</span><span class="p">));</span>
        <span class="n">var</span> <span class="n">getterLambda</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;(</span><span class="n">objectMember</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">getterLambda</span><span class="p">.</span><span class="nf">Compile</span><span class="p">().</span><span class="nf">Invoke</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>I really don&rsquo;t know what to do in the case of a MethodCallExpression as you can see inside the <em>else</em> block. However, after I can finish with the code inside that block I will be able to do this:</p>
<pre class="highlight csharp"><span class="n">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorContainer</span><span class="p">();</span>

<span class="c1">// Add a SubResolver for components with IEnumerable&lt;T&gt; dependencies on .ctors.
</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="n">Resolver</span><span class="p">.</span><span class="nf">AddSubResolver</span><span class="p">(</span>
     <span class="k">new</span> <span class="nf">CollectionResolver</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">));</span>

<span class="c1">// This is the Windsor specific impl. of IContainerConfigurator interface.
</span><span class="n">var</span> <span class="n">configurator</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorContainerConfigurator</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>

<span class="c1">// Configure the Enterprise Library Container to use Windsor internally.
</span><span class="n">EnterpriseLibraryContainer</span><span class="p">.</span><span class="nf">ConfigureContainer</span><span class="p">(</span><span class="n">configurator</span><span class="p">,</span> 
    <span class="n">ConfigurationSourceFactory</span><span class="p">.</span><span class="nf">Create</span><span class="p">());</span>

<span class="c1">// Set Current property to a new instance of the WindsorServiceLocator adapter.
</span><span class="n">EnterpriseLibraryContainer</span><span class="p">.</span><span class="n">Current</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorServiceLocator</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>
</pre>
<p>I will try to update the code as soon as I have done any changes.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2011%2F05%2F11%2Ferror-management-is-sometimes-exceptionally-difficult%2F&text=Error+Management+Is+Sometimes+Exceptionally+Difficult&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">May 11, 2011</div><div class="categories">Published in<a class="category" href="/category/castle-windsor/">Castle Windsor&nbsp;</a> on May 11, 2011</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>