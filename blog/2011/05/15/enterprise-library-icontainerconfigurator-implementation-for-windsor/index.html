<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Enterprise Library IContainerConfigurator implementation for Windsor</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1391110042" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1391110042" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1391110042" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Enterprise Library IContainerConfigurator implementation for Windsor</h1><blockquote>
<p>Alternative title: &ldquo;<a title="Error Management Is Sometimes Exceptionally Difficult" href="http://www.nikosbaxevanis.com/bonus-bits/2011/05/error-management-is-sometimes-exceptionally-difficult.html" target="_blank">Error Management Is Sometimes Exceptionally Difficult</a>, Part 2&rdquo;</p>
</blockquote>

<p>I <a href="http://www.nikosbaxevanis.com/bonus-bits/2011/05/error-management-is-sometimes-exceptionally-difficult.html" target="_blank">previously</a>&nbsp;tried to write an implementation of the <a title="Implement this interface to create an object that can read a set of TypeRegistration objects representing the current Enterprise Library configuration and configure a dependency injection container with that information." href="http://msdn.microsoft.com/en-us/library/microsoft.practices.enterpriselibrary.common.configuration.containermodel.icontainerconfigurator(v=pandp.50).aspx" target="_blank">IContainerConfigurator</a> interface. The most tricky part was extracting the container registration entry for constructing a specific type. The entry is provided in the <a title="Microsoft.Practices.EnterpriseLibrary.Common.Configuration.ContainerModel TypeRegistration(Of T) Class" href="http://msdn.microsoft.com/en-us/library/ff669651(v=pandp.50).aspx" target="_blank">TypeRegistration</a> class as a LambdaExpression and additional metadata.</p>

<p>The fact that <a title="Entry point for the container infrastructure for Enterprise Library." href="http://msdn.microsoft.com/en-us/library/microsoft.practices.enterpriselibrary.common.configuration.enterpriselibrarycontainer(v=pandp.50).aspx" target="_blank">EnterpriseLibraryContainer</a>&nbsp;class is completely decoupled from a specific container implementation made me keep trying to figure out a way to get the entries from the LamdaExpressions.</p>

<p>I posted two questions on StackOverflow, and I got all the necessary info:</p>

<ul>
<li><a rel="nofollow" href="http://blogs.msdn.com/b/agile/archive/2009/06/25/enterprise-library-5-0-architectural-refactoring-complete.aspx">Architectural Refactoring overview</a>&nbsp;(from <a title="Exception Handling Block - Manually registering the ExceptionManager class" href="http://stackoverflow.com/questions/5968725/exception-handling-block-manually-registering-the-exceptionmanager-class" target="_blank">this</a>&nbsp;question).</li>
<li>Use of the&nbsp;ParameterValue subclasses combined with the Visitor pattern over ParameterValues to make the code cleaner (from <a href="http://stackoverflow.com/questions/5955813/enterprise-library-get-value-from-parametervalue-expression" title="Enterprise Library - Get value from ParameterValue Expression" target="_blank">this</a>&nbsp;question).</li>
</ul>

<blockquote>
<p>The support I had from the project team members &nbsp;was accurate and detailed. That was great.</p>
</blockquote>

<p>The <a title="WindsorContainerConfigurator.cs" href="http://entlibcontrib.codeplex.com/SourceControl/changeset/63545" target="_blank">current</a> implementation relies heavily on Windsor&rsquo;s Property classes and it is based on the UnityContainerConfigurator.</p>

<p>Below is the WindsorParameterVisitor,</p>
<pre class="highlight csharp"><span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">WindsorParameterVisitor</span> <span class="p">:</span> <span class="n">ParameterValueVisitor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Property</span><span class="p">[]</span> <span class="n">InjectionParameters</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">VisitConstantParameterValue</span><span class="p">(</span>
         <span class="n">ConstantParameterValue</span> <span class="n">parameterValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="p">((</span><span class="n">MemberExpression</span><span class="p">)</span><span class="n">parameterValue</span><span class="p">.</span><span class="n">Expression</span><span class="p">).</span><span class="n">Member</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
        <span class="n">InjectionParameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Property</span><span class="p">[]</span> 
        <span class="p">{</span>
             <span class="n">Property</span><span class="p">.</span><span class="nf">ForKey</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">Eq</span><span class="p">(</span><span class="n">parameterValue</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span> 
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">VisitResolvedParameterValue</span><span class="p">(</span>
         <span class="n">ContainerResolvedParameter</span> <span class="n">parameterValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">InjectionParameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Property</span><span class="p">[]</span> 
        <span class="p">{</span>
             <span class="n">Property</span><span class="p">.</span><span class="nf">ForKey</span><span class="p">(</span><span class="n">parameterValue</span><span class="p">.</span><span class="n">Type</span><span class="p">).</span><span class="nf">Is</span><span class="p">(</span><span class="n">parameterValue</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span> 
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">VisitEnumerableParameterValue</span><span class="p">(</span>
         <span class="n">ContainerResolvedEnumerableParameter</span> <span class="n">parameterValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">InjectionParameters</span> <span class="p">=</span> <span class="n">parameterValue</span><span class="p">.</span><span class="n">Names</span>
           <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">name</span> <span class="p">=&gt;</span> <span class="n">Property</span><span class="p">.</span><span class="nf">ForKey</span><span class="p">(</span><span class="n">parameterValue</span><span class="p">.</span><span class="n">ElementType</span><span class="p">).</span><span class="nf">Is</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
           <span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>The ParameterValueVisitor class is needed because most TypeRegistrations are quite complex coming with both ConstructorParameters and InjectedProperties and all this stuff must be routed on the .DependsOn() method of Windsor (actually Castle.MicroKernel).</p>

<p>Below is some basic setup for configuring the Enterprise Library to use Windsor,</p>
<pre class="highlight csharp"><span class="n">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorContainer</span><span class="p">();</span>

<span class="c1">// Add a SubResolver for components with IEnumerable&lt;T&gt; dependencies on .ctors.
</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="n">Resolver</span><span class="p">.</span><span class="nf">AddSubResolver</span><span class="p">(</span>
     <span class="k">new</span> <span class="nf">CollectionResolver</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">));</span>

<span class="c1">// This is the Windsor specific impl. of IContainerConfigurator interface.
</span><span class="n">var</span> <span class="n">configurator</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorContainerConfigurator</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>

<span class="c1">// Configure the Enterprise Library Container to use Windsor internally.
</span><span class="n">EnterpriseLibraryContainer</span><span class="p">.</span><span class="nf">ConfigureContainer</span><span class="p">(</span><span class="n">configurator</span><span class="p">,</span> 
    <span class="n">ConfigurationSourceFactory</span><span class="p">.</span><span class="nf">Create</span><span class="p">());</span>

<span class="c1">// Set Current property to a new instance of the WindsorServiceLocator adapter.
</span><span class="n">EnterpriseLibraryContainer</span><span class="p">.</span><span class="n">Current</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorServiceLocator</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>
</pre>
<p>The source can be found <a href="http://entlibcontrib.codeplex.com/SourceControl/changeset/63545" target="_blank">here</a>.</p>

<p>This is tested with Exception Handling application block and I was able to resolve the ExceptionManager class.</p>
<a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2011%2F05%2F15%2Fenterprise-library-icontainerconfigurator-implementation-for-windsor%2F&text=Enterprise+Library+IContainerConfigurator+implementation+for+Windsor&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">May 15, 2011</div><div class="categories">Published in<a class="category" href="/category/castle-windsor/">Castle Windsor&nbsp;</a> on May 15, 2011</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>