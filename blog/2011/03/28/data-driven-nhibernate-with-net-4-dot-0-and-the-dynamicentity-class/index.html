<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>Data-driven NHibernate with .NET 4.0 and the DynamicEntity Class</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1394825098" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1394825098" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1394825098" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>Data-driven NHibernate with .NET 4.0 and the DynamicEntity Class</h1><div class="post"><p>The idea for this post came by a very good friend who wanted to modify his data access layer (DAL) in order to use NHibernate.</p>

<p>The DAL contains a base class that generates SQL queries and the application were it&#39;s used is completely data-driven. There is no domain, no classes, and the behaviour&#0160;is bound in various event handler methods. Changes to the database (columns, row data, etc) dictate how the application behaves.</p>

<p>The problem that comes when trying to port this kind of DAL to use NHibernate is that we have to create POCOs in order to persist everything to the database. Since the application is data-driven we would end up using an <a href="http://www.martinfowler.com/bliki/AnemicDomainModel.html" target="_blank" title="The Anemic Domain Model is a term used to describe the use of a software domain model where the business logic is implemented outside the domain objects.">anemic</a> domain model holding just the data to persist to the database and no behaviour&#0160;at all.</p>

<p>The solution for the problem is to use&#0160;dictionaries as entities, a&#0160;little-known feature of NHibernate which&#0160;allows us to define our entities as dictionaries instead of statically typed&#0160;objects.</p>

<p>Here is how to define a mapping, (notice the&#0160;entity-name instead of a class name):</p>

<p><img src="http://farm9.staticflickr.com/8506/8397466511_abfc4b24be_o.png" alt="The entity-name in mapping" /></p>

<p>The only thing we have is the mapping, no classes. In order to create a Currency object we create the following dictionary:</p>
<pre class="highlight text">var currency = new Dictionary&lt;string, object&gt;()
{
    { &quot;ISOCode&quot;,&quot;GBP&quot; },
    { &quot;EnglishName&quot;,&quot;United Kingdom Pound&quot; },
    { &quot;ExchangeRateEURtoCurrency&quot;,0.87780 },
    { &quot;ExchangeRateUpdatedOn&quot;,DateTime.UtcNow },
    { &quot;IsEnabled&quot;,true },
    { &quot;Symbol&quot;,null }
};
</pre>
<p>As you can see, the above code is cumbersome. But we can do something about it.</p>

<p>Taking advantage of the .NET 4.0 and the&#0160;<a href="http://msdn.microsoft.com/en-us/library/system.dynamic.dynamicobject.aspx" target="_blank" title="Provides a base class for specifying dynamic behavior at run time. This class must be inherited from; you cannot instantiate it directly.">DynamicObject</a>&#0160;Class, we can create a type deriving from the DynamicObject Class and&#0160;specify dynamic behaviour&#0160;at run time.&#0160;</p>

<p>Let&#39;s name our class, DynamicEntity. It must be able to:</p>

<ol>
<li>Accept a string in the .ctor specifying the entity name.</li>
<li>Set properties (PropertyName = key, PropertyValue = value) on the internal dictionary.</li>
<li>Get properties (similar to above)&#0160;from the internal dictionary.</li>
<li>Being able to expose the internal dictionary as property for NHibernate usage.</li>
<li>Being able to expose it&#39;s name as property for NHibernate usage.</li>
</ol>

<p>Here is the DynamicEntity class:</p>
<pre class="highlight text">using System;
using System.Collections.Generic;
using System.Dynamic;

public sealed class DynamicEntity : DynamicObject
{
    private readonly IDictionary&lt;string, object&gt; dictionary
        = new Dictionary&lt;string, object&gt;();

    private readonly string entityName;

    public DynamicEntity(string entityName)
    {
        this.entityName = entityName;
    }

    public string Name
    {
        get
        {
            return this.entityName;
        }
    }

    public IDictionary&lt;string, object&gt; Map
    {
        get
        {
            return this.dictionary;
        }
    }

    public override bool TryGetMember(
        GetMemberBinder binder, out object result)
    {
        if (!this.dictionary.TryGetValue(binder.Name, out result))
        {
            return false;
        }

        return true;
    }

    public override bool TrySetMember(
        SetMemberBinder binder, object value)
    {
        string key = binder.Name;

        if (this.dictionary.ContainsKey(key))
        {
            this.dictionary.Remove(key);
        }

        this.dictionary.Add(key, value);

        return true;
    }
}
</pre>
<p>Finally, here is an integration test in action:</p>
<pre class="highlight text">[Fact]
public void NHibernateShouldBeAbleToPersistCurrency()
{
    dynamic currency = new DynamicEntity(&quot;Currency&quot;);

    currency.ISOCode                   = &quot;GBP&quot;;
    currency.EnglishName               = &quot;United Kingdom Pound&quot;;
    currency.ExchangeRateEURtoCurrency = 0.87780;
    currency.ExchangeRateUpdatedOn     = DateTime.UtcNow;
    currency.IsEnabled                 = true;
    currency.Symbol                    = null;

    object id;

    using (var tx = Session.BeginTransaction())
    {
        id = Session.Save(currency.Name, currency.Map);
        tx.Commit();

        Assert.NotNull(id);
    }

    Session.Clear();

    using (var tx = Session.BeginTransaction())
    {
        var loadedCurrency = Session.Load(currency.Name, id);
        tx.Commit();

        Assert.NotNull(loadedCurrency);
    }

    Session.Flush();
}
</pre>
<p>In the above test, for Session I use the ISession.GetSession(EntityMode.Map).</p>

<p>Download the sample code <a href="https://github.com/downloads/moodmosaic/BonusBits.CodeSamples/DynamicEntity_Complete.zip" target="_self">here</a>. Updated versions will be available <a href="https://github.com/moodmosaic/BonusBits.CodeSamples/tree/master/BonusBits.CodeSamples.NHibernate" target="_blank" title="BonusBits Blog source-code for NHibernate.">here</a>.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2011%2F03%2F28%2Fdata-driven-nhibernate-with-net-4-dot-0-and-the-dynamicentity-class%2F&text=Data-driven+NHibernate+with+.NET+4.0+and+the+DynamicEntity+Class&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">March 28, 2011</div><div class="categories">Published in<a class="category" href="/category/nhibernate/">NHibernate&nbsp;</a> on March 28, 2011</div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>