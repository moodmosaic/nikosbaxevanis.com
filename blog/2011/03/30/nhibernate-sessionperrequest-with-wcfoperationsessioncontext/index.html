<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>NHibernate SessionPerRequest with WcfOperationSessionContext</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1400510317" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1400510317" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>NHibernate SessionPerRequest with WcfOperationSessionContext</h1><div class="post"><p><strong>Update:&#0160;</strong>You may download a <a href="https://github.com/moodmosaic/BonusBits.CodeSamples/tree/master/BonusBits.CodeSamples.NHibernate" target="_blank" title="WcfOperationSessionContext (Sample Application with Tests)">working example</a> using NHibernate, WCF and SQLite in-memory. The example is described also <a href="http://www.nikosbaxevanis.com/bonus-bits/2011/04/nhibernate-session-per-request-with-wcfoperationsessioncontext-part2.html" target="_blank" title="NHibernate Session Per Request with WcfOperationSessionContext (Part 2).">here</a>.</p>

<p>NHibernate 3 comes with out of the box support for the scenario where we want to have a single Session for the lifetime of a WCF request.</p>

<p>Using the <a href="http://jameskovacs.com/2011/01/21/loquacious-configuration-in-nhibernate-3/" target="_blank" title="Loquacious Configuration in NHibernate 3.">Loquacious</a>&#0160;configuration we can easily set the WcfOperationSessionContext to be the default&#0160;current session context.</p>
<pre class="highlight text">var cfg = NHibernate.Cfg.Configuration();
cfg.DataBaseIntegration(ForMySQL5)
   .CurrentSessionContext&lt;WcfOperationSessionContext&gt;()
   .Proxy(p =&gt; p.ProxyFactoryFactory&lt;ProxyFactoryFactory&gt;())
   .SessionFactory()
        .GenerateStatistics();
</pre>
<p>We also need to inspect inbound and outbound application messages prior to dispatching a request message to an operation (for binding the Session) and before returning a reply (for unbinding the Session).</p>

<p>Here is a specific&#0160;<a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.dispatcher.idispatchmessageinspector.aspx" target="_blank" title="Defines the methods that enable custom inspection or modification of inbound and outbound application messages in service applications.">IDispatchMessageInspector</a> implementation for that:</p>
<pre class="highlight text">public sealed class NHibernateWcfContextInitializer
      : IDispatchMessageInspector
  {
      private static readonly ISessionFactory sessionFactory
          = Container.Resolve&lt;ISessionFactory&gt;();

      public object AfterReceiveRequest(
          ref Message request,
          IClientChannel channel,
          InstanceContext instanceContext)
      {
          CurrentSessionContext.Bind(
              sessionFactory.OpenSession());
          return null;
      }

      public void BeforeSendReply(
          ref Message reply,
          object correlationState)
      {
          var session = CurrentSessionContext.Unbind(
               sessionFactory);

          session.Dispose();
      }
  }
</pre>
<p>Next, we need to define a custom Service Behavior that applies to every single endpoint of a service. To do that we need to define a class that implements the <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.description.iservicebehavior.aspx" target="_blank" title="Provides a mechanism to modify or insert custom extensions across an entire service, including the ServiceHostBase.">IServiceBehavior</a> interface.</p>
<pre class="highlight text">[AttributeUsage(AttributeTargets.Class)]
public sealed class NHibernateWcfContextAttribute
    : Attribute, IServiceBehavior
{
    public void AddBindingParameters(
        ServiceDescription serviceDescription, 
        ServiceHostBase serviceHostBase, 
        Collection&lt;ServiceEndpoint&gt; endpoints, 
        BindingParameterCollection bindingParameters) { }

    public void ApplyDispatchBehavior(
        ServiceDescription serviceDescription, 
        ServiceHostBase serviceHostBase)
    {
        foreach (ChannelDispatcher channelDispatcher 
            in serviceHostBase.ChannelDispatchers)
        {
            foreach (var endpoint in channelDispatcher.Endpoints)
            {
                endpoint.DispatchRuntime.MessageInspectors.Add(
                    new NHibernateWcfContextInitializer());
            }
        }
    }

    public void Validate(
        ServiceDescription serviceDescription, 
        ServiceHostBase serviceHostBase) { }
}
</pre>
<p>We can now decorate any WCF service implementation with [NHibernateWcfContext] attribute and we can access the Session using the ISessionFactory&#39;s GetCurrentSession method.</p>

<blockquote><p>When using the&#0160;<a href="http://code.google.com/p/agatha-rrsl/" target="_blank" title="Implementation of the Request/Response Service Layer for .NET">agatha-rrsl</a>&#0160;project instead of providing a WcfRequestProcessor define a custom RequestProcessor (deriving from the&#0160;WcfRequestProcessor) and decorating it with the [NHibernateWcfContext] attribute.</p></blockquote>
<pre class="highlight text">[NHibernateWcfContext]
public sealed class NHibernateWcfRequestProcessor
    : Agatha.ServiceLayer.WCF.WcfRequestProcessor { }
</pre>
<p>I would generally recommend to try all of the NHibernate&#39;s CurrentSessionContext-derived class in order to use the one that suits better for the given context. In some projects I use the WcfOperationSessionContext for the service layer and the ThreadLocalSessionContext when running&#0160;Job Schedulers.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2011%2F03%2F30%2Fnhibernate-sessionperrequest-with-wcfoperationsessioncontext%2F&text=NHibernate+SessionPerRequest+with+WcfOperationSessionContext&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">March 30, 2011</div><div class="categories">Published in<a class="category" href="/category/nhibernate/">NHibernate&nbsp;</a><a class="category" href="/category/wcf/">WCF&nbsp;</a></div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>