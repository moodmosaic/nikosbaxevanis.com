<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="Programmer using Test-Driven Development, F#, C#, and Haskell. Contributor to open-source code." name="description" /><meta content="F# C# haskell fsharp csharp tdd autofixture" name="keywords" /><title>In-memory Drain abstractions applied to A Functional Architecture with F#</title><link href="http://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" type="text/css" /><link href="/stylesheets/styles.css?1418682978" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css?1418682978" media="screen" rel="stylesheet" type="text/css" /></head><body><div><div><a href="/">‚Üê</a></div><div><h1>In-memory Drain abstractions applied to A Functional Architecture with F#</h1><div>July 28, 2014 |  <a href="/category/fsharp/">FSharp</a></div></div><div><p>This post shows how to apply the <a href="http://blog.ploeh.dk/2014/07/23/drain/">Drain</a> filter abstraction to the master branch of the Pluralsight course about <a href="http://pluralsight.com/training/Courses/TableOfContents/functional-architecture-fsharp">A Functional Architecture with F#</a> by <a href="http://blog.ploeh.dk/">Mark Seemann</a>.</p>

<p>As the diff-output shows, applying filtering with Drains cuts the maintenance of multiple homogenous abstractions, and makes the code cleaner and easier to reason about.</p>

<blockquote>
<p><em>For a better diff-output highlighting experience, there is also a Gist <a href="https://gist.github.com/moodmosaic/98d8d1854d66f58e0500" target="_blank">available here</a>.</em></p>
</blockquote>

<p>DomainModel.fs.diff:</p>
<pre class="highlight diff"><span class="gh">diff --git a/BookingApi/DomainModel.fs b/BookingApi/DomainModel.fs
index 4a4260f..c2079cf 100644
</span><span class="gd">--- a/BookingApi/DomainModel.fs
</span><span class="gi">+++ b/BookingApi/DomainModel.fs
</span><span class="gh">@@ -7,6 +7,23 @@ type Period =
</span>     | Month of int * int
     | Day of int * int * int
<span class="err">
</span><span class="gi">+[&lt;AutoOpen&gt;]
+module Drain =
+    type IDrainable&lt;'a, 'b&gt; =
+        inherit seq&lt;'a&gt;
+        abstract On : 'b -&gt; seq&lt;'a&gt;
+
+    let on x (d : IDrainable&lt;'a, 'b&gt;) = d.On x
+
+    let ofSeq areEqual s =
+        { new IDrainable&lt;'a, 'b&gt; with
+            member this.On x = s |&gt; Seq.filter (fun y -&gt; areEqual y x)
+            member this.GetEnumerator() = s.GetEnumerator()
+            member this.GetEnumerator() =
+                (this :&gt; 'a seq).GetEnumerator() :&gt; System.Collections.IEnumerator }
+
+    let empty&lt;'a, 'b&gt; = Seq.empty&lt;'a&gt; |&gt; ofSeq (fun x (y : 'b) -&gt; false)
+
</span> module Dates =
     let InitInfinite (date : DateTime) =
         date |&gt; Seq.unfold (fun d -&gt; Some(d, d.AddDays 1.0))
<span class="gh">@@ -30,24 +47,11 @@ module Dates =
</span><span class="err">
</span> module Reservations =
<span class="err">
</span><span class="gd">-    type IReservations =
-        inherit seq&lt;Envelope&lt;Reservation&gt;&gt;
-        abstract Between : DateTime -&gt; DateTime -&gt; seq&lt;Envelope&lt;Reservation&gt;&gt;
-
-    type ReservationsInMemory(reservations) =
-        interface IReservations with
-            member this.Between min max =
-                reservations
-                |&gt; Seq.filter (fun r -&gt; min &lt;= r.Item.Date &amp;&amp; r.Item.Date &lt;= max)
-            member this.GetEnumerator() =
-                reservations.GetEnumerator()
-            member this.GetEnumerator() =
-                (this :&gt; seq&lt;Envelope&lt;Reservation&gt;&gt;).GetEnumerator() :&gt; System.Collections.IEnumerator
-
-    let ToReservations reservations = ReservationsInMemory(reservations)
</span><span class="gi">+    let ToReservations reservations =
+        reservations |&gt; Drain.ofSeq (fun x y -&gt; x.Item.Date &gt;= fst y &amp;&amp; x.Item.Date &lt;= snd y)
</span><span class="err">
</span><span class="gd">-    let Between min max (reservations : IReservations) =
-        reservations.Between min max
</span><span class="gi">+    let Between min max (reservations : IDrainable&lt;Envelope&lt;Reservation&gt;, DateTime * DateTime&gt;) =
+        reservations |&gt; Drain.on(min, max)
</span><span class="err">
</span>     let On (date : DateTime) reservations =
         let min = date.Date
<span class="gh">@@ -73,18 +77,8 @@ module Reservations =
</span><span class="err">
</span> module Notifications =
<span class="err">
</span><span class="gd">-    type INotifications =
-        inherit seq&lt;Envelope&lt;Notification&gt;&gt;
-        abstract About : Guid -&gt; seq&lt;Envelope&lt;Notification&gt;&gt;
-
-    type NotificationsInMemory(notifications : Envelope&lt;Notification&gt; seq) =
-        interface INotifications with
-            member this.About id =
-                notifications |&gt; Seq.filter (fun n -&gt; n.Item.About = id)
-            member this.GetEnumerator() = notifications.GetEnumerator()
-            member this.GetEnumerator() = 
-                (this :&gt; Envelope&lt;Notification&gt; seq).GetEnumerator() :&gt; System.Collections.IEnumerator
-
-    let ToNotifications notifications = NotificationsInMemory(notifications)
-
-    let About id (notifications : INotifications) = notifications.About id
</span><span class="gi">+    let ToNotifications notifications =
+        notifications |&gt; Drain.ofSeq (fun x y -&gt; x.Item.About = y)
+ 
+    let About id (notifications : IDrainable&lt;Envelope&lt;Notification&gt;, Guid&gt;) =
+        notifications |&gt; Drain.on id
</span></pre>
<p>Controllers.fs.diff:</p>
<pre class="highlight diff"><span class="gh">diff --git a/BookingApi/Controllers.fs b/BookingApi/Controllers.fs
index 2234ae0..986c5a9 100644
</span><span class="gd">--- a/BookingApi/Controllers.fs
</span><span class="gi">+++ b/BookingApi/Controllers.fs
</span><span class="gh">@@ -41,7 +41,7 @@ type ReservationsController() =
</span>         if disposing then subject.Dispose()
         base.Dispose disposing
<span class="err">
</span><span class="gd">-type NotificationsController(notifications : Notifications.INotifications) =
</span><span class="gi">+type NotificationsController(notifications) =
</span>     inherit ApiController()
<span class="err">
</span>     member this.Get id =
<span class="gh">@@ -61,7 +61,7 @@ type NotificationsController(notifications : Notifications.INotifications) =
</span><span class="err">
</span>     member this.Notifications = notifications
<span class="err">
</span><span class="gd">-type AvailabilityController(reservations : Reservations.IReservations,
</span><span class="gi">+type AvailabilityController(reservations,
</span>                             seatingCapacity : int) =
     inherit ApiController()
</pre>
<p>Infrastructure.fs.diff:</p>
<pre class="highlight diff"><span class="gh">diff --git a/BookingApi/Infrastructure.fs b/BookingApi/Infrastructure.fs
index 18867a8..7082d19 100644
</span><span class="gd">--- a/BookingApi/Infrastructure.fs
</span><span class="gi">+++ b/BookingApi/Infrastructure.fs
</span><span class="gh">@@ -9,7 +9,7 @@ open System.Reactive
</span> open FSharp.Reactive
 open Ploeh.Samples.Booking.HttpApi.Reservations
<span class="err">
</span><span class="gd">-type CompositionRoot(reservations : IReservations,
</span><span class="gi">+type CompositionRoot(reservations,
</span>                      notifications,
                      reservationRequestObserver,
                      seatingCapacity) =
</pre>
<p>TestDsl.fs.diff:</p>
<pre class="highlight diff"><span class="gh">diff --git a/BookingApi.UnitTests/TestDsl.fs b/BookingApi.UnitTests/TestDsl.fs
index df09626..cde8e4d 100644
</span><span class="gd">--- a/BookingApi.UnitTests/TestDsl.fs
</span><span class="gi">+++ b/BookingApi.UnitTests/TestDsl.fs
</span><span class="gh">@@ -37,19 +37,20 @@ type DateStringCustomization() =
</span>                             (context.Resolve typeof&lt;DateTime&gt; :?&gt; DateTime).ToString &quot;yyyy.MM.dd&quot; :&gt; obj
                         | _ -&gt; NoSpecimen(request) :&gt; obj }
<span class="err">
</span><span class="gi">+open Ploeh.Samples.Booking.HttpApi
+open Ploeh.Samples.Booking.HttpApi.Notifications
+
</span> type NotificationsCustomization() =
     interface ICustomization with
         member this.Customize fixture =
<span class="gd">-            fixture.Customizations.Add(
-                TypeRelay(
-                    typeof&lt;Ploeh.Samples.Booking.HttpApi.Notifications.INotifications&gt;,
-                    typeof&lt;Ploeh.Samples.Booking.HttpApi.Notifications.NotificationsInMemory&gt;))
-
</span><span class="gi">+            let notifications =
+                fixture.CreateMany&lt;Envelope&lt;Notification&gt;&gt;() |&gt; ToNotifications
+            fixture.Inject notifications
+ 
</span> type ReservationsCustomization() =
     interface ICustomization with
         member this.Customize fixture =
<span class="gd">-            fixture.Inject&lt;Ploeh.Samples.Booking.HttpApi.Reservations.IReservations&gt;(
-                [] |&gt; Ploeh.Samples.Booking.HttpApi.Reservations.ToReservations)
</span><span class="gi">+            fixture.Inject Drain.empty&lt;Envelope&lt;Reservation&gt;, DateTime * DateTime&gt;
</span><span class="err">
</span> type TestConventions() =
     inherit CompositeCustomization(
</pre>
<p>DomainModelTests.fs.diff:</p>
<pre class="highlight diff"><span class="gh">diff --git a/BookingApi.UnitTests/DomainModelTests.fs b/BookingApi.UnitTests/DomainModelTests.fs
index 221e560..c021706 100644
</span><span class="gd">--- a/BookingApi.UnitTests/DomainModelTests.fs
</span><span class="gi">+++ b/BookingApi.UnitTests/DomainModelTests.fs
</span><span class="gh">@@ -92,14 +92,10 @@ module DatesTests =
</span><span class="err">
</span> module ReserverationsTests =
     open Reservations
<span class="gd">-
-    [&lt;Theory; TestConventions&gt;]
-    let ReservationsInMemoryAreReservations (sut : ReservationsInMemory) =
-        Assert.IsAssignableFrom&lt;IReservations&gt;(sut)
</span><span class="err">
</span>     [&lt;Theory; TestConventions&gt;]
     let ToReservationsReturnsCorrectResult (expected : Envelope&lt;Reservation&gt; seq) =
<span class="gd">-        let actual : ReservationsInMemory = expected |&gt; ToReservations
</span><span class="gi">+        let actual = expected |&gt; ToReservations
</span>         Assert.Equal&lt;Envelope&lt;Reservation&gt;&gt;(expected, actual)
<span class="err">
</span>     [&lt;Theory; TestConventions&gt;]
<span class="gh">@@ -111,7 +107,7 @@ module ReserverationsTests =
</span>         let expected = reservations |&gt; Seq.skip 2 |&gt; Seq.take 6
         let sut = reservations |&gt; ToReservations
<span class="err">
</span><span class="gd">-        let actual = (sut :&gt; IReservations).Between min.Item.Date max.Item.Date
</span><span class="gi">+        let actual = sut |&gt; Drain.on(min.Item.Date, max.Item.Date)
</span><span class="err">
</span>         Assert.Equal&lt;Envelope&lt;Reservation&gt;&gt;(expected, actual)
<span class="err">
</span><span class="gh">@@ -125,7 +121,7 @@ module ReserverationsTests =
</span><span class="err">
</span>         let actual = sut |&gt; Between min.Item.Date max.Item.Date
<span class="err">
</span><span class="gd">-        let expected = (sut :&gt; IReservations).Between min.Item.Date max.Item.Date
</span><span class="gi">+        let expected = sut |&gt; Drain.on(min.Item.Date, max.Item.Date)
</span>         Assert.Equal&lt;Envelope&lt;Reservation&gt;&gt;(expected, actual)
<span class="err">
</span>     [&lt;Theory; TestConventions&gt;]
<span class="gh">@@ -203,12 +199,8 @@ module NotificationsTest =
</span>     open Notifications
<span class="err">
</span>     [&lt;Theory; TestConventions&gt;]
<span class="gd">-    let NotificationsInMemoryAreNotifications (sut : NotificationsInMemory) =
-        Assert.IsAssignableFrom&lt;INotifications&gt; sut
-
-    [&lt;Theory; TestConventions&gt;]
</span>     let ToNotificationsReturnsCorrectResult (expected : Envelope&lt;Notification&gt; seq) =
<span class="gd">-        let actual : NotificationsInMemory = expected |&gt; ToNotifications
</span><span class="gi">+        let actual = expected |&gt; ToNotifications
</span>         Assert.Equal&lt;Envelope&lt;Notification&gt;&gt;(expected, actual)
<span class="err">
</span>     [&lt;Theory; TestConventions&gt;]
<span class="gh">@@ -219,7 +211,7 @@ module NotificationsTest =
</span>         let expected = notifications |&gt; PickRandom
         let sut = notifications |&gt; ToNotifications
<span class="err">
</span><span class="gd">-        let actual = (sut :&gt; INotifications).About expected.Item.About
</span><span class="gi">+        let actual = sut |&gt; Drain.on expected.Item.About
</span><span class="err">
</span>         Assert.Equal(1, actual |&gt; Seq.length)
         Assert.Equal(expected, actual |&gt; Seq.head)
<span class="gh">@@ -232,7 +224,7 @@ module NotificationsTest =
</span>         let sut = generator |&gt; Seq.take 10 |&gt; Seq.toList |&gt; ToNotifications
         Assert.False(sut |&gt; Seq.exists (fun n -&gt; n.Item.About = about))
<span class="err">
</span><span class="gd">-        let actual = (sut :&gt; INotifications).About about
</span><span class="gi">+        let actual = sut |&gt; Drain.on about
</span><span class="err">
</span>         Assert.True(actual |&gt; Seq.isEmpty)
<span class="err">
</span><span class="gh">@@ -241,7 +233,7 @@ module NotificationsTest =
</span>         let sut = notifications |&gt; ToNotifications
         let about = (sut |&gt; Seq.toList |&gt; PickRandom).Item.About
<span class="err">
</span><span class="gd">-        let actual : Envelope&lt;Notification&gt; seq = sut |&gt; About about
</span><span class="gi">+        let actual = sut |&gt; About about
</span><span class="err">
</span><span class="gd">-        let expected = (sut :&gt; INotifications).About about
</span><span class="gi">+        let expected = sut |&gt; Drain.on about
</span>         Assert.Equal&lt;Envelope&lt;Notification&gt;&gt;(expected, actual)
</pre>
<p>ControllerTests.fs.diff</p>
<pre class="highlight diff"><span class="gh">diff --git a/BookingApi.UnitTests/ControllerTests.fs b/BookingApi.UnitTests/ControllerTests.fs
index 166278e..05f9363 100644
</span><span class="gd">--- a/BookingApi.UnitTests/ControllerTests.fs
</span><span class="gi">+++ b/BookingApi.UnitTests/ControllerTests.fs
</span><span class="gh">@@ -79,11 +79,11 @@ module NotificationsControllerTests =
</span><span class="err">
</span>     [&lt;Theory; TestConventions&gt;]
     let NotificationsAreExposedForExpection
<span class="gd">-        ([&lt;Frozen&gt;]expected : Notifications.INotifications)
</span><span class="gi">+        ([&lt;Frozen&gt;]expected : IDrainable&lt;Envelope&lt;Notification&gt;, Guid&gt;)
</span>         (sut : NotificationsController) =
<span class="err">
</span><span class="gd">-        let actual : Notifications.INotifications = sut.Notifications
-        Assert.Equal&lt;Notifications.INotifications&gt;(expected, actual)
</span><span class="gi">+        let actual = sut.Notifications
+        Assert.Equal&lt;IDrainable&lt;Envelope&lt;Notification&gt;, Guid&gt;&gt;(expected, actual)
</span><span class="err">
</span>     [&lt;Theory; TestConventions&gt;]
     let GetWithoutMatchingNotificationReturnsCorrectResult
<span class="gh">@@ -187,7 +187,7 @@ module AvailabilityControllerTests =
</span>                                                     yearsInFuture : int) =
         // Fixture setup
         let reservations = mutableReservations |&gt; Reservations.ToReservations
<span class="gd">-        fixture.Inject&lt;Reservations.IReservations&gt; reservations
</span><span class="gi">+        fixture.Inject reservations
</span>         let sut =
             fixture.Generate&lt;AvailabilityController&gt;()
             |&gt; Seq.filter (fun c -&gt; c.SeatingCapacity &gt; 1)
<span class="gh">@@ -284,7 +284,7 @@ module AvailabilityControllerTests =
</span>                                                      yearsInFuture : int) =
         // Fixture setup
         let reservations = mutableReservations |&gt; Reservations.ToReservations
<span class="gd">-        fixture.Inject&lt;Reservations.IReservations&gt; reservations
</span><span class="gi">+        fixture.Inject reservations
</span>         let sut =
             fixture.Generate&lt;AvailabilityController&gt;()
             |&gt; Seq.filter (fun c -&gt; c.SeatingCapacity &gt; 1)
<span class="gh">@@ -395,7 +395,7 @@ module AvailabilityControllerTests =
</span>                                                    yearsInFuture : int) =
         // Fixture setup
         let reservations = mutableReservations |&gt; Reservations.ToReservations
<span class="gd">-        fixture.Inject&lt;Reservations.IReservations&gt; reservations
</span><span class="gi">+        fixture.Inject reservations
</span>         let sut =
             fixture.Generate&lt;AvailabilityController&gt;()
             |&gt; Seq.filter (fun c -&gt; c.SeatingCapacity &gt; 1)
</pre>
<p>To apply the diff, access the source code by getting <a href="http://pluralsight.com/training/Products/Individual">a Pluralsight subscription</a> which is totally worth it for this course.</p>
</div><div class="footer">Have a question about this post? Ask away on   <a href="http://twitter.com/nikosbaxevanis" target="_blank">Twitter</a> or in <a href="https://github.com/moodmosaic/feedback" target="_blank">my feedback repo</a>.</div></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>