<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, user-scalable=no" name="viewport" /><title>mountebank stubs with F#</title><link href="http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans" rel="stylesheet" type="text/css" /><link href="/stylesheets/fontello.css?1400438949" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/styles.css?1400438949" media="screen" rel="stylesheet" type="text/css" /></head><body><div class="row"><h1>mountebank stubs with F#</h1><div class="post"><p>The <a href="http://nikosbaxevanis.com/blog/2014/04/22/mountebank-mocks-with-f-number/">previous post</a> described what mountebank is, as well as how to use mountebank imposters as Mocks via HTTP and F#.</p>

<p>This post describes how to use mountebank imposters as Stubs via HTTP, xUnit.net, and F#.</p>

<h3>Scenario</h3>

<p>The <a href="http://www.mbtest.org/docs/api/stubs">Stub example</a> in mountebank API documentation simulates a RESTful endpoint that creates a Customer, the first time it&#39;s called, and returns a 400 Bad Request the second time it&#39;s called with the same Customer because the email address already exists.</p>

<h3>Intercepting imposter Stub setup</h3>

<p>When using mountebank imposters as Stubs we typically care about configuring the Stub&#39;s return values - the rest of the <a href="http://xunitpatterns.com/fixture%20setup.html">fixture setup</a> and <a href="http://xunitpatterns.com/fixture%20teardown.html">fixture teardown</a> phases are always the same.</p>

<p>If fixture setup and fixture teardown phases are always the same, they could be extracted into an <a href="http://en.wikipedia.org/wiki/Interceptor_pattern">Interceptor</a> class.</p>

<p>In <a href="https://github.com/xunit/xunit">xUnit.net</a> we can do this by inheriting from <a href="https://github.com/xunit/xunit/blob/master/src/xunit.core/Sdk/BeforeAfterTestAttribute.cs">BeforeAfterTestAttribute</a>:</p>
<pre class="highlight text">type UseImposterStubAttribute (mountebankHost, mountebankPort, imposterJson) =
    inherit BeforeAfterTestAttribute()

    override this.Before (methodUnderTest : MethodInfo) =
        Http.Request(
            UriBuilder(
                &quot;http&quot;, 
                mountebankHost, 
                mountebankPort, 
                &quot;imposters/&quot;).ToString(),
            headers = [ 
              &quot;Content-Type&quot;, HttpContentTypes.Json; 
              &quot;Accept&quot;      , HttpContentTypes.Json ],
            httpMethod = &quot;POST&quot;,
            body = TextRequest imposterJson)
        |&gt; ignore

    override this.After (methodUnderTest : MethodInfo) =
        Http.Request(
            UriBuilder(
                &quot;http&quot;, 
                mountebankHost, 
                mountebankPort, 
                &quot;imposters/&quot; + ParsePortFrom(imposterJson)).ToString(),
            headers = [ 
                &quot;Content-Type&quot;, HttpContentTypes.Json; 
                &quot;Accept&quot;      , HttpContentTypes.Json ],
            httpMethod = &quot;DELETE&quot;)
        |&gt; ignore
</pre>
<h3>Using imposter Stubs with xUnit.net</h3>

<p>With xUnit.net and the <code>UseImposterStubAttribute</code>, the original <a href="http://www.mbtest.org/docs/api/stubs">Stub example</a> can be written as:</p>
<pre class="highlight text">[&lt;Fact; UseImposterStub(
    &quot;192.168.1.4&quot;, 
    2525, 
    @&quot;
    {
      &quot;&quot;port&quot;&quot;:4545,
      &quot;&quot;protocol&quot;&quot;:&quot;&quot;http&quot;&quot;,
      &quot;&quot;stubs&quot;&quot;:[
        {
          &quot;&quot;responses&quot;&quot;:[
            {
              &quot;&quot;is&quot;&quot;:{
                &quot;&quot;statusCode&quot;&quot;:201,
                &quot;&quot;headers&quot;&quot;:{
                  &quot;&quot;Location&quot;&quot;:&quot;&quot;http://localhost:4545/customers/123&quot;&quot;,
                  &quot;&quot;Content-Type&quot;&quot;:&quot;&quot;application/xml&quot;&quot;
                },
                &quot;&quot;body&quot;&quot;:&quot;&quot;&lt;customer&gt;&lt;email&gt;customer@test.com&lt;/email&gt;&lt;/customer&gt;&quot;&quot;
              }
            },
            {
              &quot;&quot;is&quot;&quot;:{
                &quot;&quot;statusCode&quot;&quot;:400,
                &quot;&quot;headers&quot;&quot;:{
                  &quot;&quot;Content-Type&quot;&quot;:&quot;&quot;application/xml&quot;&quot;
                },
                &quot;&quot;body&quot;&quot;:&quot;&quot;&lt;error&gt;email already exists&lt;/error&gt;&quot;&quot;
              }
            }
          ]
        }
      ]
    }&quot;
)&gt;]
let CreateDuplicateCustomerThrows () =
    let expected = 201
    let mutable secondRequestHasFailed = false

    let actual = 
        Create &quot;&lt;customer&gt;&lt;email&gt;customer@test.com&lt;/email&gt;&lt;/customer&gt;&quot;
    try
        Create &quot;&lt;customer&gt;&lt;email&gt;customer@test.com&lt;/email&gt;&lt;/customer&gt;&quot; |&gt; ignore
    with
    | e -&gt; if e.Message.Contains(&quot;email already exists&quot;) 
           then secondRequestHasFailed &lt;- true

    verify &lt;@ actual.StatusCode = expected &amp;&amp; secondRequestHasFailed @&gt;
</pre>
<p>The <code>UseImposterStubAttribute</code> arguments are</p>

<ul>
<li>the mountebank server host</li>
<li>the mountebank server port number</li>
<li>the imposter (protocol, port, and return values) specified in the JSON setup</li>
</ul>

<p>When running the test, the output on the mountebank server console is:</p>
<pre class="highlight text">info: [mb:2525] POST /imposters/
info: [http:4545] Open for business...
info: [http:4545] 192.168.1.5:62897 =&gt; POST /imposters/
info: [http:4545] 192.168.1.5:62898 =&gt; POST /imposters/
info: [mb:2525] DELETE /imposters/4545
</pre>
<ul>
<li>During the setup phase an imposter Stub is created via HTTP POST using the the mountebank URL and imposter protocol (http) and port (4545) defined in the <code>UseImposterStubAttribute</code>.</li>
<li>During the teardown phase the imposter Stub is removed.</li>
</ul>

<blockquote>
<p>The important part is that the <code>UseImposterStubAttribute</code> removes the repetitive imposter setup and teardown steps from the actual test.</p>
</blockquote>

<h3>TCP Stubs</h3>

<p><a href="http://brandonbyars.com/">Brandon Byars</a>, the creator of mountebank, provided an <a href="http://brandonbyars.com/2014/02/10/stubbing-a-mule-tcp-connector-with-mountebank/">example</a> of how to create TCP imposter Stubs with Java.</p>

<p>It is now easy to do something similar with F#, xUnit.net and the <code>UseImposterStubAttribute</code>:</p>
<pre class="highlight text">[&lt;Fact; UseImposterStub(
    &quot;192.168.1.4&quot;, 
    2525, 
    @&quot;
    {
      &quot;&quot;protocol&quot;&quot;:&quot;&quot;tcp&quot;&quot;,
      &quot;&quot;port&quot;&quot;:&quot;&quot;4546&quot;&quot;,
      &quot;&quot;mode&quot;&quot;:&quot;&quot;binary&quot;&quot;,
      &quot;&quot;stubs&quot;&quot;:[
        {
          &quot;&quot;responses&quot;&quot;:[
            {
              &quot;&quot;is&quot;&quot;:{
                &quot;&quot;data&quot;&quot;: &quot;&quot;&lt;encoded string&gt;&quot;&quot;
              }
            }
          ]
        }
      ]
    }&quot;
)&gt;]
let QueryWithCancelledTravelPlan () = 
    // (Java to F#-pseudocode conversion)
    let expected = { travelPlan with Status = &quot;Cancelled&quot; }
    let actual = sut.Query(&quot;http://travelPlans/1234&amp;date=2013-02-15&quot;);
    verify &lt;@ actual .. expected @&gt;
</pre>
<p>The complete source code is available on this <a href="https://gist.github.com/moodmosaic/1fbad33d03b11b188edc">gist</a> - any comments or suggestions are always welcome.</p>
</div><a class="twitter" href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnikosbaxevanis.com%2Fblog%2F2014%2F05%2F02%2Fmountebank-stubs-with-f-number%2F&text=mountebank+stubs+with+F%23&via=nikosbaxevanis" target="_blank">Tweet This</a><div class="dater">May 02, 2014</div><div class="categories">Published in<a class="category" href="/category/unit-testing/">Unit Testing&nbsp;</a><a class="category" href="/category/fsharp/">FSharp&nbsp;</a></div></div><div class="homer"><a href="/"><i class="icon-tape" style="font-size:32px;"></i></a></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-24262928-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>